---
title: "AMP_ves_summary_plots"
author: "Jessica McCordic"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

## Load libraries


```{r load libraries and helper script, include=FALSE, message=FALSE, warning=FALSE, echo=FALSE}

#### Load libraries ####

# NOAA-approved tidyverse
tidyverse_short<-c("broom","cli","crayon","dbplyr","dplyr","dtplyr","forcats","ggplot2","googledrive","googlesheets4","hms","httr","jsonlite","lubridate","magrittr","modelr","pillar","purrr","readr","readxl","reprex","rlang","rstudioapi","rvest","stringr","tibble","tidyr","xml2") 
lapply(tidyverse_short, require, character.only = TRUE) 

library(scales)
library(ggalt)
library(ggsci)
library(ggdist)
library(ggh4x) # nested faceting

theme_set(theme_bw(
  base_size = 14
))

# source helper file
source("code/AMP_summary_ves_funs.R")
```

## Load hourly presence datasets

```{r Load data, include=FALSE}

#### Load compiled hourly presence table ####
# This is generated using Reformat_data_for_HP script

all_sites_hp <- read_csv("data/All_sites_tables/hourly_pres_allsites_local.csv")
all_sites_inout <- read_csv("data/All_sites_tables/total_ves_ins_out_by_site.csv")

```

## Reshape data for plotting

```{r reshape tables, include = FALSE}

#### Add columns to original dataset to help group for plotting ####

all_sites_hp <- all_sites_hp |>
  mutate(
    # replace NA's with 0's to accurately incorporate hours with presence = 0
    Total_Vessels = replace_na(Total_Vessels, 0),
    total_inside = replace_na(total_inside, 0),
    total_inside_small = replace_na(total_inside_small, 0),
    
    # add categorical Y/N column for vessels present to calculate proportions
    ves_yn = ifelse(Total_Vessels == 0, "N","Y"),
    ins_ves_yn = ifelse(total_inside == 0, "N","Y"),
    ins_ves_small_yn = ifelse(total_inside_small == 0, "N","Y"),
    
    # add date without year to collapse across years
    Month = month(Begin_Date_loc),
    Week = isoweek(Begin_Date_loc),
    Day_month = mday(Begin_Date_loc),
    # re-create dates as all in the same year for plotting on single graph
    Date_noyr = as_date(paste0("2000", "-", Month, "-", Day_month), format = "%Y-%m-%d"),
    # get start date for each week
    Date_week = as_date(paste(as.character(year(Begin_Date_loc)),Week,"1",sep = "-"), format = "%Y-%W-%w"),
    
    # add season based on month
    season = case_when(month(Date_noyr) == 12 | month(Date_noyr) == 1 | month(Date_noyr) == 2 ~ "Summer",
                       month(Date_noyr) == 3 | month(Date_noyr) == 4 | month(Date_noyr) == 5 ~ "Autumn",
                       month(Date_noyr) == 6 | month(Date_noyr) == 7 | month(Date_noyr) == 8 ~ "Winter",
                        TRUE ~ "Spring"
    ),
    
    # add AMP Regional Networks and NPZ IDs based on Site_ID
    network = case_when(Site_ID == "CG" | Site_ID == "EP" | Site_ID == "WP" ~ "Temperate East",
                        Site_ID == "DNE" | Site_ID == "DSW" | Site_ID == "NGN"| Site_ID == "NGS" ~ "Northwest",
                        TRUE ~ "South-west"
    ),
    npz_id = case_when(
      # Cod Grounds
      Site_ID == "CG" ~ "CGMP", 
      # Solitary Islands
      Site_ID == "EP" | Site_ID == "WP" ~ "SIMP",
      # Dampier
      Site_ID == "DNE" | Site_ID == "DSW" ~ "DMP",
      # Ningaloo
      Site_ID == "NGN"| Site_ID == "NGS" ~ "NMP", 
      # Two Rocks
      Site_ID == "TRE" | Site_ID == "TRW" ~ "TRMP", 
      # Jurien
      Site_ID == "JSE" | Site_ID == "JNE" ~ "JMP", 
      # Geographe
      Site_ID == "GEO" ~ "GMP",
      # Murat
      Site_ID == "MRE" | Site_ID == "MRW" ~ "MMP",
      # South-west Corner
      Site_ID == "SWS" ~ "SWCMP" 
    )
  )

```

## Data gaps

Add in dates without coverage 
**(this is still in progress)**

```{r data gaps, include=FALSE}


# load in deployment info CSV

# deploy_info <- read_csv("data/AMP_deployment_info.csv")
# 
# date_gaps <- deploy_info |>
#   mutate(Dep = gsub(pattern = "PARKSAUSTRALIA_",
#                     replacement = "",
#                     x = PROJECT_NAME)) |>
#   left_join(all_sites_hp, by = "Dep", multiple = "first") |>
#   select(c(Dep, all_dep_start, pre_site_gap_end, 
#            post_site_gap_start, all_dep_end,
#            dep_gap_start, dep_gap_end, 
#            network, npz_id, Site_ID))

```

## Data summary and visualization

### Total vessel presence per deployment

Raw total counts per deployments and vessels inside the NPZs
Deployment-level and NPZ-level info

```{r total presence, message=FALSE, warning=FALSE}

# summarize in-out data to get n vessels used for I-O analysis per deployment
ins_out_counts <- all_sites_inout |>
  group_by(Dep_ID) |>
  summarize(n_ves_used_inout = n()) |>
  rename("Dep" = "Dep_ID")

# summarize full df to get counts per deployment
all_ves_by_site <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep_ID, Dep) |>
  summarise(n_days = n_distinct(Begin_Date_loc),
            Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE),
            mean_per_day = Total_ves_dep/n_days,
            mean_overall = mean(Total_Vessels)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small) |>
  left_join(ins_out_counts, by = "Dep") |>
  mutate(
    prop_inside = Total_inside/n_ves_used_inout,
    total_outside = n_ves_used_inout - Total_inside,
    prop_inside_small = Total_inside_small/n_ves_used_inout,
    total_out_small = n_ves_used_inout - Total_inside_small)


all_ves_by_npz <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep_ID, Dep) |>
  left_join(ins_out_counts, by = "Dep") |>
  ungroup() |>
  group_by(network, npz_id) |>
  summarise(n_days = n_distinct(Site_ID, Begin_Date_loc),
            Total_ves_npz = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE),
            mean_per_day = Total_ves_npz/n_days,
            
            n_used_inout = sum(unique(n_ves_used_inout)),
            
            mean_overall = mean(Total_Vessels),
           ) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small,
         total_outside = n_used_inout - Total_inside,
         total_out_small = n_used_inout - Total_inside_small,
         prop_inside = Total_inside/n_used_inout,
         prop_inside_small = Total_inside_small/sum(n_used_inout))



all_ves_long <- all_ves_by_site |>
  pivot_longer(cols = -c(network, npz_id, Site_ID, Dep_ID, Dep, n_days), values_to = "Ves_counts", names_to = "Ves_behav") |>
  # relevel categorical values for plotting
  mutate(Ves_behav = fct(Ves_behav),
         Ves_behav = fct_relevel(Ves_behav, c("Total_ves_dep","Total_inside_small", "Total_inside", "Inside_transit_small","Inside_maneuver_small", "Inside_transit","Inside_maneuver")),
         network = fct(network),
         network = fct_relevel(network, c("Temperate East","Northwest"))) |>
  # add diverging counts where inside values are negative for plotting
  mutate(ves_counts_diverge = ifelse(Ves_behav == "Total_inside" | Ves_behav == "Total_inside_small",Ves_counts*(-1),Ves_counts),
         npz_id = fct(npz_id),
         npz_id = fct_relevel(npz_id, c("CGMP","SIMP","DMP","NMP")))
```


```{r plots by deployment}
ggplot(data = all_ves_by_site,
       aes(x = Dep,
           y = Total_ves_dep,
           fill = npz_id)) +
  geom_col(show.legend = FALSE,
           color = "black") +
  scale_fill_viridis_d()+
  facet_grid(~network, 
             scales = "free_x", 
             space = "free", 
             drop = TRUE) +
  labs(x = "NPZ",
       y = "N vessels",
       title = "Total vessel counts") +
  theme(
    axis.text.x = element_text(angle = 90),
    strip.text.x = element_text(face = "bold")
    )


# counts including inside-outside
ggplot(data = all_ves_long,
       aes(x = npz_id,
           y = Ves_counts,
           fill = Ves_behav)) +
  geom_col(position = position_dodge()) +
  scale_fill_viridis_d()+
  # facet_grid(rows = vars(network), 
  #            scales = "free_x", 
  #            space = "free", 
  #            drop = TRUE) +
  labs(x = "NPZ",
       y = "N vessels",
       title = "Total vessel counts") +
  theme(
    axis.text.x = element_text(angle = 90),
    strip.text.x = element_text(face = "bold")
    )


# inside vs outside proportion plot (fill to equal 1.0)
ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_outside" |
               Ves_behav == "Total_inside",
               npz_id != "SWCMP"),
       aes(x = npz_id,
           y = Ves_counts,
           fill = Ves_behav)) +
  geom_col(position = position_fill(reverse = TRUE)) +
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "Proportion vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Proportions") +
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.x = element_text(face = "bold")
    )

####
# Diverging bar plot - NPZ
#### 

breakvals <- seq(-200, 800, 200)

ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_outside" |
               Ves_behav == "Total_inside",
               npz_id != "SWCMP"),
       aes(x = npz_id,
           y = ves_counts_diverge,
           fill = Ves_behav)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip()+
  scale_y_continuous(limits = c(-200, 800),
                     breaks = breakvals, 
                     labels = abs(breakvals))+
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "N vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Totals") +
  facet_grid(rows = vars(network),
             scales = "free",
             space = "free",
             drop = TRUE)+
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Ins_out_counts_npz.png"), width=10, height=6,
       units="in", dpi=300)

# Small vessels inside-outside

breakvals_small <- seq(-600, 600, 200)

ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_out_small" |
               Ves_behav == "Total_inside_small",
               npz_id != "SWCMP"),
       aes(x = npz_id,
           y = ves_counts_diverge,
           fill = Ves_behav)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip()+
  scale_y_continuous(limits = c(-600, 600),
                     breaks = breakvals_small, 
                     labels = abs(breakvals_small))+
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "N vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Counts (Small Vessels)") +
   facet_grid(rows = vars(network),
             scales = "free",
             space = "free",
             drop = TRUE)+
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Ins_out_counts_small_npz.png"), width=10, height=6,
       units="in", dpi=300)


```


### Diverging bar plot by Deployment

```{r div bar by npz}

####
# Diverging bar plot - NPZ
#### 

breakvals <- seq(-400, 800, 50)

ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_outside" |
               Ves_behav == "Total_inside",
               npz_id != "SWCMP"),
       aes(x = npz_id,
           y = ves_counts_diverge,
           fill = Ves_behav)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip()+
  scale_y_continuous(limits = c(-200, 800),
                     breaks = breakvals, 
                     labels = abs(breakvals))+
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "N vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Totals") +
  facet_grid(vars(network),
             scales = "free",
             space = "free",
             drop = TRUE)+
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Ins_out_counts_npz.png"), width=10, height=8,
       units="in", dpi=300)

# Small vessels inside-outside

breakvals_small <- seq(-600, 600, 50)

ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_out_small" |
               Ves_behav == "Total_inside_small",
               npz_id != "SWCMP"),
       aes(x = npz_id,
           y = ves_counts_diverge,
           fill = Ves_behav)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip()+
  scale_y_continuous(limits = c(-600, 600),
                     breaks = breakvals_small, 
                     labels = abs(breakvals_small))+
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "N vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Counts (Small Vessels)") +
   facet_grid(rows = vars(network),
             scales = "free",
             space = "free",
             drop = TRUE)+
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Ins_out_counts_small_npz.png"), width=10, height=8,
       units="in", dpi=300)




```



## Temporal patterns

### Weekday patterns

Calculate mean-adjusted totals per weekday, similar to Moussoline et al. 2012 diel presence

- For all full weeks (7d), Calculate weekly mean of daily totals per deployment
- For each weekday, calculate [daily total - weekly mean]
- values will be +/- relative to weekly mean

For weeks with vessel presence, the mean-adjusted weekday counts were highest in ___ NPZ on __day. Multiple NPZs showed higher presence on __days overall. 


First, get daily totals grouped by weekday for each vessel category

```{r weekday mean adjusted}

# start by getting daily counts
all_ves_wkdy <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep, Date_week, Weekday, Begin_Date_loc)|>
  # get daily vessel counts per weekday: total, inside, inside_small, maneuver, maneuver_small
  summarise(Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small, 
         Weekday = factor(Weekday, levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")),
         network = case_when(Site_ID == "CG" | Site_ID == "EP" | Site_ID == "WP" ~ "Temperate East",
                             Site_ID == "DNE" | Site_ID == "DSW" | Site_ID == "NGN"| Site_ID == "NGS" ~ "Northwest", 
                             TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west"))) 
levels(all_ves_wkdy$Weekday) <- c("M","T","W","R","F","Sa","Su")


# Calculate mean daily presence for each week per category
wkly_means <- all_ves_wkdy |>
  group_by(network, npz_id, Site_ID, Dep, Date_week) |>
  summarize(n_days = n(),
            mean_tot = mean(Total_ves_dep, na.rm = TRUE),
            mean_ins = mean(Total_inside, na.rm = TRUE),
            mean_ins_sm = mean(Total_inside_small, na.rm = TRUE),
            mean_trans = mean(Inside_transit, na.rm = TRUE),
            mean_trans_sm = mean(Inside_transit_small, na.rm = TRUE),
            mean_man = mean(Inside_maneuver, na.rm = TRUE), 
            mean_man_sm = mean(Inside_maneuver_small, na.rm = TRUE))
            
# join weekly means to full weekday dataset
wkdy_mean_adj <- all_ves_wkdy |>
  left_join(wkly_means, by = c("Date_week", "Dep")) |>
  group_by(network.x, npz_id.x, Weekday) |>
  # only keep full weeks (7 days) and weeks with any vessels present
  filter(n_days == 7, 
         mean_tot > 0) |>
  # mean-adjusted value = count per weekday - weekly mean
  mutate(tot_wk_adj = Total_ves_dep - mean_tot,
         ins_wk_adj = Total_inside - mean_ins,
         ins_sm_adj = Total_inside_small - mean_ins_sm) |>
  summarise(mean_wk = mean(tot_wk_adj, na.rm = TRUE),
            mean_wk_ins = mean(ins_wk_adj, na.rm = TRUE),
            mean_wk_ins_sm = mean(ins_sm_adj, na.rm = TRUE)) |>
  mutate(sd_lower = mean_wk - 0.5*(sd(mean_wk)),
         sd_upper = mean_wk + 0.5*(sd(mean_wk)),
         sd_lower_ins = mean_wk_ins - 0.5*(sd(mean_wk_ins)),
         sd_upper_ins = mean_wk_ins + 0.5*(sd(mean_wk_ins)),
         sd_lower_ins_sm = mean_wk_ins - 0.5*(sd(mean_wk_ins)),
         sd_upper_ins_sm = mean_wk_ins_sm + 0.5*(sd(mean_wk_ins_sm)),
         npz_id.x = fct(npz_id.x),
         npz_id.x = fct_relevel(npz_id.x, c("CGMP","SIMP","DMP","NMP")))

ggplot(data = wkdy_mean_adj,
       aes(x = Weekday, y = mean_wk)) +
  geom_pointrange(aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id.x,
                      color = ifelse(sd_lower <= 0, 'firebrick','blue')),
                  size = 0.25,
                  show.legend = FALSE) +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  scale_color_manual(values = c("red","black"))+
  labs(y = "Mean-adjusted average N vessels / weekday",
       x = "Weekday")+
  facet_nested(rows = vars(network.x, npz_id.x), 
               nest_line = element_line(),
               scales = "free_y") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Weekday_mean_adj_npz_presentonly.png"), width=8, height=10, units="in", dpi=300)

```




```{r pooling SIMP sites}
### Compare CGMP deployments
cgmp_wkdy <- all_ves_wkdy |>
  filter(Site_ID == "CG") |>
  group_by(Dep, Weekday) |>
  summarise(Total_ves_dep = sum(Total_ves_dep)) |>
  pivot_wider(names_from = Dep, values_from = Total_ves_dep)

### Compare SIMP deployments
simp_wkdy <- all_ves_wkdy |>
  filter(npz_id == "SIMP")|>
  group_by(Dep, Weekday) |>
  summarise(Total_ves_dep = sum(Total_ves_dep)) |>
  pivot_wider(names_from = Dep, values_from = Total_ves_dep)

# Chi squared tests
# EP vs. WP in same deployment --> can we pool them?

chisq.test(as.data.frame(simp_wkdy[,2:3], row.names = FALSE)) # NS
chisq.test(as.data.frame(simp_wkdy[,4:5], row.names = FALSE)) # NS
chisq.test(as.data.frame(simp_wkdy[,6:7], row.names = FALSE)) # sig (but NS for same dates)

# test if WP subset to same dates is different
simp_epwp_dates <- all_ves_wkdy |>
  filter(npz_id == "SIMP", 
         Begin_Date_loc > "2019-06-10" & Begin_Date_loc < "2019-06-30") |>
  group_by(Dep, Weekday) |>
  summarise(Total_ves_dep = sum(Total_ves_dep)) |>
  pivot_wider(names_from = Dep, values_from = Total_ves_dep)


```


## Daily proportional hours present

Summarize by weekday

```{r prop across weekdays}

# from full hp dataset
# group down to date level to get daily vessel counts for each category (total, inside, inside_small, transit, maneuver)
# remove any days without vessels present
# group by deployment and weekday
# get proportion of vessel counts for each category occurring on each weekday
# 

all_ves_wkdy <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep, Weekday)|>
  # get daily vessel countsper weekday: total, inside, inside_small, maneuver, maneuver_small
  summarise(Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small, 
         Weekday = factor(Weekday, levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")),
         network = case_when(Site_ID == "CG" | Site_ID == "EP" | Site_ID == "WP" ~ "Temperate East",
                             Site_ID == "DNE" | Site_ID == "DSW" | Site_ID == "NGN"| Site_ID == "NGS" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west"))) |>
  filter(Total_ves_dep > 0) 

levels(all_ves_wkdy$Weekday) <- c("M","T","W","R","F","Sa","Su")


# function to calculate Agresti-Coull interval
# from https://towardsdatascience.com/five-confidence-intervals-for-proportions-that-you-should-know-about-7ff5484c024f
AgrestiInterval <- function(x, n, conf.level = 0.95){
 p <- (x+2)/(n+4)
 sd <- sqrt(p*((1-p)/(n+4)))
 z <- qnorm(c( (1 - conf.level)/2, 1- (1-conf.level)/2)) #returns the value of thresholds at which conf.level has to be cut at. for 95% CI, this is -1.96 and +1.96
 ci <- p + z*sd
 return(ci)
 }

wkdy_prop_table <- all_ves_wkdy |>
  group_by(network, npz_id, Site_ID, Dep) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small,
         tot_prop = Total_ves_dep/sum(Total_ves_dep),
         ins_prop = Total_inside/sum(Total_inside),
         small_prop = Total_inside_small/sum(Total_inside_small),
         ins_trans_prop = Inside_transit/sum(Inside_transit),
         small_trans_prop = Inside_transit_small/sum(Inside_transit_small),
         ins_man_prop = Inside_maneuver/sum(Inside_maneuver),
         small_man_prop = Inside_maneuver_small/sum(Inside_maneuver_small))

wkdy_prop_long <- wkdy_prop_table |>
  pivot_longer(cols = -c(network, npz_id, Site_ID, Dep, Weekday), 
               values_to = "Weekday_prop", names_to = "Ves_behav") |>
  filter(grepl("prop", Ves_behav)) |>
  # relevel categorical values for plotting
  mutate(Ves_behav = fct(Ves_behav),
         Ves_behav = fct_relevel(Ves_behav, c("tot_prop","small_prop", "ins_prop", "small_trans_prop","small_man_prop", "ins_trans_prop","ins_man_prop")),
         # network = fct(network),
         network = fct_relevel(network, c("Temperate East","Northwest")), 
         npz_id = fct(npz_id),
         npz_id = fct_relevel(npz_id, c("CGMP","SIMP","DMP","NMP")))



# TO DO:
# - calculate A-C confidence intervals for each proportion
# - add CI's to plot
```




## Proportional hours present

For days with presence AND 24 total hours (i.e., full days only)
- Calculate proportion of hours present (n/24)
- Summarize by weekday (median, 25th - 75th percentiles)


```{r weekday prophrs}
#### Proportional by hours present rather than counts ####

# start with full hp dataset
all_perc_weekday <- all_sites_hp |>
  # group by date to get % presence per day 
  group_by(network, npz_id, Site_ID, Dep, Date_noyr, Begin_Date_loc, Weekday, ves_yn) |>
  # get total number of hours for Y and N groups per each hour per deployment
  summarize(n_hours = n())|>
  # only keep full days
  filter(sum(n_hours) == 24) |>
  # calculate proportion hours present per day
  mutate(freq = n_hours/sum(n_hours)) |>
  # ungroup to fill in any missing values for columns
  ungroup() |>
  complete(Dep, Weekday, ves_yn,
           fill = list(ves_yn = "Y", freq = 0)) |>
  # regroup
  group_by(network, npz_id, Site_ID, Dep, Begin_Date_loc, Weekday, ves_yn) |>
  # reshape for easier plotting
  pivot_longer(cols = c("freq"),
               values_to = "Perc_per_hour") |>
  mutate(Weekday = factor(Weekday, levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")),
          network = case_when(Site_ID == "CG" | Site_ID == "EP" | Site_ID == "WP" ~ "Temperate East",
                              Site_ID == "DNE" | Site_ID == "DSW" | Site_ID == "NGN"| Site_ID == "NGS" ~ "Northwest",
                              TRUE ~ "South-west"
          ),
          network = factor(network, levels = c("Temperate East","Northwest","South-west")))
levels(all_perc_weekday$Weekday) <- c("M","T","W","R","F","Sa","Su")


# summarize proportion hours present

# by deployment
perc_wkdy_summ_dep <- all_perc_weekday |>
  # only interested in proportion present
  filter(ves_yn == "Y") |>
  ungroup()|>
  # group down to weekday level to summarize
  group_by(network, npz_id, Site_ID, Dep, Weekday)|>
  summarise(median_prop = median(Perc_per_hour),
            qt25 = quantile(Perc_per_hour, probs = 0.25),
            qt75 = quantile(Perc_per_hour, probs = 0.75),
            min_perc = min(Perc_per_hour, na.rm = TRUE),
            max_perc = max(Perc_per_hour, na.rm = TRUE))

# by npz
perc_wkdy_summ_npz <- all_perc_weekday |>
  filter(ves_yn == "Y") |>
  ungroup()|>
  group_by(network, npz_id, Weekday)|>
  summarise(median_prop = median(Perc_per_hour),
            qt25 = quantile(Perc_per_hour, probs = 0.25),
            qt75 = quantile(Perc_per_hour, probs = 0.75),
            min_perc = min(Perc_per_hour, na.rm = TRUE),
            max_perc = max(Perc_per_hour, na.rm = TRUE))

```


Daily proportion of hours present, summarized by weekday
"For days with vessels present, what proportion of the day had vessels?
When those are summarized by Weekday, what's the median value for each weekday at each NPZ?"

```{r weekday proportion hours}

## Try individual npz's for a single network

## Temperate East
ggplot(data = all_perc_weekday |>
         filter(ves_yn == "Y",
                !is.na(npz_id),
                network == "Temperate East"),
       aes(x = Weekday,
           y = Perc_per_hour,
           fill = npz_id,
           color = npz_id))+
  geom_boxplot(
    position = position_dodge2(preserve = "single"),
    alpha = 0.75,
    width = 0.5)+
  scale_fill_viridis_d(end = 0.75,
                       direction = -1
  )+
  scale_color_viridis_d(end = 0.75,
                        direction = -1,
                        guide = "none")+
  facet_grid(rows = vars(Dep),
             drop = TRUE) +
  labs(x = "Weekday",
       y = "Proportion hours per weekday",
       fill = "Deployment") +
  theme(
    strip.text.y = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold")
  )
# 
ggsave(paste0("figs/", "Weekday_prop_hrs_npz_tempeast_dep.png"), width=6, height=10,
       units="in", dpi=300)




## Northwest
ggplot(data = all_perc_weekday |>
         filter(ves_yn == "Y",
                !is.na(npz_id),
                network == "Northwest"),
       aes(x = Weekday,
           y = Perc_per_hour,
           fill = npz_id,
           color = npz_id))+
  geom_boxplot(
    position = position_dodge2(preserve = "single"),
    alpha = 0.75,
    width = 0.5)+
  scale_fill_viridis_d(end = 0.75,
                       direction = -1
  )+
  scale_color_viridis_d(end = 0.75,
                        direction = -1,
                        guide = "none")+
  facet_grid(rows = vars(npz_id),
             drop = TRUE) +
  labs(x = "Weekday",
       y = "Proportion hours per weekday",
       fill = "NPZ") +
  theme(
    strip.text.y = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold")
  )
# 
ggsave(paste0("figs/", "Weekday_prop_hrs_npz_northwest.png"), width=6, height=10,
       units="in", dpi=300)

## South-west
ggplot(data = all_perc_weekday |>
         filter(ves_yn == "Y",
                !is.na(npz_id),
                network == "South-west"),
       aes(x = Weekday,
           y = Perc_per_hour,
           fill = npz_id,
           color = npz_id))+
  geom_boxplot(
    position = position_dodge2(preserve = "single"),
    alpha = 0.75,
    width = 0.5)+
  scale_fill_viridis_d(end = 0.75,
                       direction = -1
  )+
  scale_color_viridis_d(end = 0.75,
                        direction = -1,
                        guide = "none")+
  facet_grid(rows = vars(npz_id),
             drop = TRUE) +
  labs(x = "Weekday",
       y = "Proportion hours per weekday",
       fill = "NPZ") +
  theme(
    strip.text.y = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold")
  )
# 
ggsave(paste0("figs/", "Weekday_prop_hrs_npz_southwest.png"), width=6, height=10,
       units="in", dpi=300)


# no facets, plotting at network level

ggplot(data = all_perc_weekday |>
         filter(ves_yn == "Y",
                Perc_per_hour > 0, 
                !is.na(npz_id)),
       aes(x = Weekday,
           y = Perc_per_hour,
           fill = network,
           color = network))+
  geom_boxplot(
    position = position_dodge2(preserve = "single"),
    alpha = 0.75,
    width = 0.5)+
  scale_fill_viridis_d(end = 0.75,
                       direction = -1
  )+
  scale_color_viridis_d(end = 0.75,
                        direction = -1,
                        guide = "none")+
  # facet_grid(rows = vars(npz_id),
  #            drop = TRUE) +
  labs(x = "Weekday",
       y = "Hours present / hours per day",
       fill = "Network") +
  theme(
    strip.text.y = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold")
  )
ggsave(paste0("figs/", "Weekday_prop_hrs_nofacets.png"), width=6, height=10,
       units="in", dpi=300)





```



## Plotting weekday proportions

```{r weekday plots}


wkday_prop_total <- wkdy_prop_long |>
  filter(Ves_behav == "tot_prop")

ggplot(data = wkday_prop_total,
       aes(x = Weekday, 
           y = Weekday_prop)) +
  geom_col(aes(fill = network),
           position = position_dodge()) +
  scale_fill_viridis_d(end = 0.75, direction = -1)+
  labs(y = "Proportion", 
       x = "Weekday", 
       fill = "Network")+  
  facet_grid(rows = vars(npz_id)) +
   theme(
    axis.text.x = element_text(face = "bold"),
    strip.text.y = element_text(face = "bold")
    )



ggsave(paste0("figs/", "Weekday_props_npz.png"), width=8, height=10,
       units="in", dpi=300)




wkday_prop_ins <- wkdy_prop_long |>
  filter(Ves_behav == "ins_prop" | Ves_behav == "ins_trans_prop" | Ves_behav == "ins_man_prop")

ggplot(data = wkday_prop_ins |> filter (npz_id != "MMP" & npz_id != "SWCMP"),
       aes(x = Weekday, 
           y = Weekday_prop)) +
  geom_col(aes(fill = Ves_behav),
           position = position_dodge()) +
  scale_fill_viridis_d(end = 0.75, direction = -1)+
  labs(y = "Proportion", 
       x = "Weekday", 
       fill = "Network")+  
  facet_grid(rows = vars(npz_id),
             cols = vars(Ves_behav)) +
   theme(
    axis.text.x = element_text(face = "bold"),
    strip.text.y = element_text(face = "bold")
    )



ggsave(paste0("figs/", "Weekday_props_npz_inside.png"), width=8, height=10, units="in", dpi=300)






```


## Daily mean-adjusted diel presence

```{r mean adj diel}
# start by getting hourly counts
all_ves_diel <- all_sites_hp |>
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc, Begin_Hour_loc)|>
  # get daily vessel counts per weekday: total, inside, inside_small, maneuver, maneuver_small
  summarise(Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small, 
         # Weekday = factor(Weekday, levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")),
         network = case_when(npz_id == "CGMP" | npz_id == "SIMP" ~ "Temperate East",
                             npz_id == "DMP" | npz_id == "NMP" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west"))) 


# summarize daily totals to get mean-adjusted counts per weekday
daily_means <- all_ves_diel |>
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
  summarize(n_hrs = n(),
            mean_tot = mean(Total_ves_dep, na.rm = TRUE),
            mean_ins = mean(Total_inside, na.rm = TRUE),
            mean_ins_sm = mean(Total_inside_small, na.rm = TRUE),
            mean_trans = mean(Inside_transit, na.rm = TRUE),
            mean_trans_sm = mean(Inside_transit_small, na.rm = TRUE),
            mean_man = mean(Inside_maneuver, na.rm = TRUE), 
            mean_man_sm = mean(Inside_maneuver_small, na.rm = TRUE))
            
  
diel_mean_depid <- all_ves_diel |>
  left_join(daily_means, by = c("Begin_Date_loc", "Dep"), keep = FALSE) |>
  group_by(network.x, npz_id.x, Dep_ID.x, Begin_Hour_loc) |>
  filter(n_hrs == 24, # only keep full days
         # only keep days with presence for mean-adjusting
         mean_tot > 0) |>
  mutate(tot_diel_adj = Total_ves_dep - mean_tot,
         ins_diel_adj = Total_inside - mean_ins,
         ins_sm_adj = Total_inside_small - mean_ins_sm) |>
  summarise(mean_diel = mean(tot_diel_adj, na.rm = TRUE),
            mean_diel_ins = mean(ins_diel_adj, na.rm = TRUE),
            mean_diel_ins_sm = mean(ins_sm_adj, na.rm = TRUE)) |>
  mutate(sd_lower = mean_diel - 0.5*(sd(mean_diel)),
         sd_upper = mean_diel + 0.5*(sd(mean_diel)),
         sd_lower_ins = mean_diel_ins - 0.5*(sd(mean_diel_ins)),
         sd_upper_ins = mean_diel_ins + 0.5*(sd(mean_diel_ins)),
         sd_lower_ins_sm = mean_diel_ins - 0.5*(sd(mean_diel_ins)),
         sd_upper_ins_sm = mean_diel_ins_sm + 0.5*(sd(mean_diel_ins_sm)))


# plot
ggplot(data = diel_mean_depid,
       aes(x = factor(Begin_Hour_loc), 
           y = mean_diel)) +
  geom_pointrange(aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id.x,
                      color = ifelse(sd_lower <= 0, 'firebrick','blue')),
                  size = 0.25,
                  show.legend = FALSE) +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  scale_color_manual(values = c("red","black"))+
  labs(y = "Mean-adjusted average N vessels / hour",
       x = "Hour of Day (Local TZ)")+
   facet_nested(rows = vars(network.x, npz_id.x, Dep_ID.x), 
               nest_line = element_line(),
               scales = "free_y") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )
ggsave(paste0("figs/", "Diel_mean_adj_dep_presonly.png"), width=8, height=10, units="in", dpi=300)




# summarize to npz level
diel_mean_adj_npz <- all_ves_diel |>
  left_join(daily_means, by = c("Begin_Date_loc", "Dep"), keep = FALSE) |>
  group_by(network.x, npz_id.x, Begin_Hour_loc) |>
  mutate(tot_diel_adj = Total_ves_dep - mean_tot,
         ins_diel_adj = Total_inside - mean_ins,
         ins_sm_adj = Total_inside_small - mean_ins_sm) |>
  summarise(mean_diel = mean(tot_diel_adj, na.rm = TRUE),
            mean_diel_ins = mean(ins_diel_adj, na.rm = TRUE),
            mean_diel_ins_sm = mean(ins_sm_adj, na.rm = TRUE)) |>
  mutate(sd_lower = mean_diel - 0.5*(sd(mean_diel)),
         sd_upper = mean_diel + 0.5*(sd(mean_diel)),
         sd_lower_ins = mean_diel_ins - 0.5*(sd(mean_diel_ins)),
         sd_upper_ins = mean_diel_ins + 0.5*(sd(mean_diel_ins)),
         sd_lower_ins_sm = mean_diel_ins - 0.5*(sd(mean_diel_ins)),
         sd_upper_ins_sm = mean_diel_ins_sm + 0.5*(sd(mean_diel_ins_sm)))
   
   
ggplot(data = diel_mean_npz,
       aes(x = factor(Begin_Hour_loc), 
           y = mean_diel)) +
  geom_hline(yintercept = 0, colour = "grey50") +
  geom_pointrange(aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id.x,
                      color = ifelse(sd_lower <= 0, 'firebrick','blue')),
                  size = 0.25,
                  show.legend = FALSE) +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  scale_color_manual(values = c("red","black"))+
  labs(y = "Mean-adjusted average N vessels / hour",
       x = "Hour of Day (Local TZ)")+
   facet_nested(rows = vars(network.x, npz_id.x), 
               nest_line = element_line(),
               scales = "free_y") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Diel_mean_adj_npz_presonly.png"), width=8, height=10, units="in", dpi=300)


# Inside small vessels

ggplot(data = diel_mean_npz |> filter(npz_id.x != "SWCMP"),
       aes(x = factor(Begin_Hour_loc), 
           y = mean_diel_ins_sm)) +
  geom_hline(yintercept = 0, colour = "grey50") +
  geom_pointrange(aes(ymin = sd_lower_ins_sm,
                      ymax = sd_upper_ins_sm,
                      group = npz_id.x,
                      color = ifelse(mean_diel_ins_sm < 0, 'firebrick','blue')),
                  size = 0.25,
                  show.legend = FALSE) +
  scale_color_viridis_d(begin = 0.3, end = 0.7, 
                        option = "H",
                        direction = -1)+
  labs(y = "Mean-adjusted average N vessels / hour",
       x = "Hour of Day (Local TZ)")+
  facet_grid(rows = vars(npz_id.x)) +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Diel_mean_adj_npz_ins_sm.png"), width=8, height=10, units="in", dpi=300)








```



### Export CSV summary tables

```{r export tables}

# Total vessel presence
write_csv(all_ves_by_site, 
          file = "output/All_ves_by_dep.csv")
write_csv(all_ves_by_npz, 
          file = "output/All_ves_by_npz.csv")
write_csv(all_ves_wkdy, 
          file = "output/All_ves_by_weekday.csv")
write_csv(cgmp_wkdy,
          file = "output/CGMP_by_weekday.csv")

write_csv(all_perc_weekday, 
          file = "output/All_ves_prophr_weekday.csv")
write_csv(perc_wkdy_summ_npz, 
          file = "output/All_ves_prophr_weekday_npz.csv")
write_csv(perc_wkdy_summ_dep, 
          file = "output/All_ves_prophr_weekday_dep.csv")
write_csv(all_ves_diel, 
          file = "output/All_ves_diel_counts.csv")
write_csv(diel_mean_adj, 
          file = "output/All_ves_diel_mean_adj.csv")

```
