---
title: "AMP_ves_summary_plots"
author: "Jessica McCordic"
date: "`r Sys.Date()`"
output: html_document
---

## Load libraries
# test
```{r load libraries and helper script, include=FALSE, echo=FALSE}

#### Load libraries ####

# NOAA-approved tidyverse
tidyverse_short<-c("broom","cli","crayon","dbplyr","dplyr","dtplyr","forcats","ggplot2","googledrive","googlesheets4","hms","httr","jsonlite","lubridate","magrittr","modelr","pillar","purrr","readr","readxl","reprex","rlang","rstudioapi","rvest","stringr","tibble","tidyr","xml2") 
lapply(tidyverse_short, require, character.only = TRUE) 

library(scales)
library(ggalt)
library(ggsci)
library(ggdist)

theme_set(theme_bw(
  base_size = 14
))

# source helper file
source("code/AMP_summary_ves_funs.R")
```

## Load hourly presence datasets

```{r Load data}

#### Load compiled hourly presence table ####
# This is generated using Reformat_data_for_HP script

all_sites_hp <- read_csv("data/All_sites_tables/hourly_pres_allsites_local.csv")
all_sites_inout <- read_csv("data/All_sites_tables/total_ves_ins_out_by_site.csv")

```

## Reshape data for plotting

```{r reshape tables}

#### Add columns to original dataset to help group for plotting ####

all_sites_hp <- all_sites_hp |>
  mutate(
    # replace NA's with 0's to accurately incorporate hours with presence = 0
    Total_Vessels = replace_na(Total_Vessels, 0),
    total_inside = replace_na(total_inside, 0),
    total_inside_small = replace_na(total_inside_small, 0),
    
    # add categorical Y/N column for vessels present to calculate proportions
    ves_yn = ifelse(Total_Vessels == 0, "N","Y"),
    ins_ves_yn = ifelse(total_inside == 0, "N","Y"),
    ins_ves_small_yn = ifelse(total_inside_small == 0, "N","Y"),
    
    # add date without year to collapse across years
    Month = month(Begin_Date_loc),
    Week = isoweek(Begin_Date_loc),
    Day_month = mday(Begin_Date_loc),
    # re-create dates as all in the same year for plotting on single graph
    Date_noyr = as_date(paste0("2000", "-", Month, "-", Day_month), format = "%Y-%m-%d"),
    # get start date for each week
    Date_week = as_date(paste(Week,"1",sep = "-"), format = "%U-%u"),
    
    # add AMP Regional Networks and NPZ IDs based on Site_ID
    network = case_when(Site_ID == "CG" | Site_ID == "EP" | Site_ID == "WP" ~ "Temperate East",
                        Site_ID == "DNE" | Site_ID == "DSW" | Site_ID == "NGN"| Site_ID == "NGS" ~ "Northwest",
                        TRUE ~ "South-west"
    ),
    npz_id = case_when(
      # Cod Grounds
      Site_ID == "CG" ~ "CGMP", 
      # Solitary Islands
      Site_ID == "EP" | Site_ID == "WP" ~ "SIMP",
      # Dampier
      Site_ID == "DNE" | Site_ID == "DSW" ~ "DMP",
      # Ningaloo
      Site_ID == "NGN"| Site_ID == "NGS" ~ "NMP", 
      # Two Rocks
      Site_ID == "TRE" | Site_ID == "TRW" ~ "TRMP", 
      # Jurien
      Site_ID == "JSE" | Site_ID == "JNE" ~ "JMP", 
      # Geographe
      Site_ID == "GEO" ~ "GMP",
      # Murat
      Site_ID == "MRE" | Site_ID == "MRW" ~ "MMP",
      # South-west Corner
      Site_ID == "SWS" ~ "SWCMP" 
    )
  )

```

## Data gaps

Add in dates without coverage 
(this is still in progress)

```{r data gaps}


## Still need to troubleshoot this!!!

# load in deployment info CSV

# deploy_info <- read_csv("data/AMP_deployment_info.csv")
# 
# date_gaps <- deploy_info |>
#   mutate(Dep = gsub(pattern = "PARKSAUSTRALIA_",
#                     replacement = "",
#                     x = PROJECT_NAME)) |>
#   left_join(all_sites_hp, by = "Dep", multiple = "first") |>
#   select(c(Dep, all_dep_start, pre_site_gap_end, 
#            post_site_gap_start, all_dep_end,
#            dep_gap_start, dep_gap_end, 
#            network, npz_id, Site_ID))

```

## Data summary and visualization

### Total vessel presence per deployment

Raw total counts per deployments and vessels inside the NPZs
Deployment-level and NPZ-level info

```{r total presence}

# summarize in-out data to get n vessels used for I-O analysis per deployment
ins_out_counts <- all_sites_inout |>
  group_by(Dep_ID) |>
  summarize(n_ves_used_inout = n()) |>
  rename("Dep" = "Dep_ID")

# summarize full df to get counts per deployment
all_ves_by_site <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep) |>
  summarise(n_days = n_distinct(Begin_Date_loc),
            Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE),
            mean_per_day = Total_ves_dep/n_days,
            mean_overall = mean(Total_Vessels)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small) |>
  left_join(ins_out_counts, by = "Dep") |>
  mutate(
    prop_inside = Total_inside/n_ves_used_inout,
    total_outside = n_ves_used_inout - Total_inside,
    prop_inside_small = Total_inside_small/n_ves_used_inout,
    total_out_small = n_ves_used_inout - Total_inside_small)


all_ves_by_npz <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep) |>
  left_join(ins_out_counts, by = "Dep") |>
  ungroup() |>
  group_by(network, npz_id) |>
  summarise(n_days = n_distinct(Site_ID, Begin_Date_loc),
            Total_ves_npz = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE),
            mean_per_day = Total_ves_npz/n_days,
            
            n_used_inout = sum(unique(n_ves_used_inout)),
            
            mean_overall = mean(Total_Vessels),
           ) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small,
         total_outside = n_used_inout - Total_inside,
         total_out_small = n_used_inout - Total_inside_small,
         prop_inside = Total_inside/n_used_inout,
         prop_inside_small = Total_inside_small/sum(n_used_inout))



all_ves_long <- all_ves_by_site |>
  pivot_longer(cols = -c(network, npz_id, Site_ID, Dep, n_days), values_to = "Ves_counts", names_to = "Ves_behav") |>
  # relevel categorical values for plotting
  mutate(Ves_behav = fct(Ves_behav),
         Ves_behav = fct_relevel(Ves_behav, c("Total_ves_dep","Total_inside_small", "Total_inside", "Inside_transit_small","Inside_maneuver_small", "Inside_transit","Inside_maneuver")),
         network = fct(network),
         network = fct_relevel(network, c("Temperate East","Northwest"))) |>
  # add diverging counts where inside values are negative for plotting
  mutate(ves_counts_diverge = ifelse(Ves_behav == "Total_inside" | Ves_behav == "Total_inside_small",Ves_counts*(-1),Ves_counts),
         npz_id = fct(npz_id),
         npz_id = fct_relevel(npz_id, c("CGMP","SIMP","DMP","NMP")))
```


```{r plots by deployment}
ggplot(data = all_ves_by_site,
       aes(x = Dep,
           y = Total_ves_dep,
           fill = npz_id)) +
  geom_col(show.legend = FALSE,
           color = "black") +
  scale_fill_viridis_d()+
  facet_grid(~network, 
             scales = "free_x", 
             space = "free", 
             drop = TRUE) +
  labs(x = "NPZ",
       y = "N vessels",
       title = "Total vessel counts") +
  theme(
    axis.text.x = element_text(angle = 90),
    strip.text.x = element_text(face = "bold")
    )


# counts including inside-outside
ggplot(data = all_ves_long,
       aes(x = npz_id,
           y = Ves_counts,
           fill = Ves_behav)) +
  geom_col(position = position_dodge()) +
  scale_fill_viridis_d()+
  # facet_grid(rows = vars(network), 
  #            scales = "free_x", 
  #            space = "free", 
  #            drop = TRUE) +
  labs(x = "NPZ",
       y = "N vessels",
       title = "Total vessel counts") +
  theme(
    axis.text.x = element_text(angle = 90),
    strip.text.x = element_text(face = "bold")
    )


# inside vs outside proportion plot (fill to equal 1.0)
ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_outside" |
               Ves_behav == "Total_inside",
               npz_id != "SWCMP"),
       aes(x = npz_id,
           y = Ves_counts,
           fill = Ves_behav)) +
  geom_col(position = position_fill(reverse = TRUE)) +
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "Proportion vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Proportions") +
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.x = element_text(face = "bold")
    )

####
# Diverging bar plot - NPZ
#### 

breakvals <- seq(-200, 800, 200)

ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_outside" |
               Ves_behav == "Total_inside",
               npz_id != "SWCMP",
               npz_id != "MMP"),
       aes(x = npz_id,
           y = ves_counts_diverge,
           fill = Ves_behav)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip()+
  scale_y_continuous(limits = c(-200, 800),
                     breaks = breakvals, 
                     labels = abs(breakvals))+
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "N vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Totals") +
  facet_grid(rows = vars(network),
             scales = "free",
             space = "free",
             drop = TRUE)+
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Ins_out_counts_npz.png"), width=10, height=6,
       units="in", dpi=300)

# Small vessels inside-outside

breakvals_small <- seq(-600, 600, 200)

ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_out_small" |
               Ves_behav == "Total_inside_small",
               npz_id != "SWCMP"),
       aes(x = npz_id,
           y = ves_counts_diverge,
           fill = Ves_behav)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip()+
  scale_y_continuous(limits = c(-600, 600),
                     breaks = breakvals_small, 
                     labels = abs(breakvals_small))+
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "N vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Counts (Small Vessels)") +
   facet_grid(rows = vars(network),
             scales = "free",
             space = "free",
             drop = TRUE)+
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Ins_out_counts_small_npz.png"), width=10, height=6,
       units="in", dpi=300)


```


### Diverging bar plot by Deployment

```{r div bar by dep}

####
# Diverging bar plot - NPZ
#### 

breakvals <- seq(-400, 800, 50)

ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_outside" |
               Ves_behav == "Total_inside",
               npz_id != "SWCMP",
               npz_id != "MMP"),
       aes(x = Dep,
           y = ves_counts_diverge,
           fill = Ves_behav)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip()+
  scale_y_continuous(limits = c(-400, 400),
                     breaks = breakvals, 
                     labels = abs(breakvals))+
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "N vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Totals") +
  facet_grid(vars(npz_id),
             scales = "free",
             space = "free",
             drop = TRUE)+
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Ins_out_counts_dep.png"), width=10, height=8,
       units="in", dpi=300)

# Small vessels inside-outside

breakvals_small <- seq(-600, 600, 50)

ggplot(data = all_ves_long |> 
         filter(Ves_behav == "total_out_small" |
               Ves_behav == "Total_inside_small",
               npz_id != "SWCMP",
               npz_id != "MMP"),
       aes(x = Dep,
           y = ves_counts_diverge,
           fill = Ves_behav)) +
  geom_col(position = position_stack(reverse = TRUE)) +
  coord_flip()+
  scale_y_continuous(limits = c(-400, 400),
                     breaks = breakvals_small, 
                     labels = abs(breakvals_small))+
  scale_fill_viridis_d(direction = -1)+
  labs(x = "NPZ",
       y = "N vessels",
       fill = "Inside vs. Outside",
       title = "Inside-Outside Counts (Small Vessels)") +
   facet_grid(rows = vars(npz_id),
             scales = "free",
             space = "free",
             drop = TRUE)+
  theme(
    # axis.text.x = element_text(angle = 90),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Ins_out_counts_small_dep.png"), width=10, height=8,
       units="in", dpi=300)




```



## Weekday patterns

Of days with vessels present, what proportion occurred on each weekday?


```{r reshape for weekday}

# from full hp dataset
# group down to date level to get daily vessel counts for each category (total, inside, inside_small, transit, maneuver)
# remove any days without vessels present
# group by deployment and weekday
# get proportion of vessels for each category occurring on each weekday
# 

all_ves_wkdy <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep, Weekday)|>
  # get daily vessel counts: total, inside, inside_small, maneuver, maneuver_small
  summarise(Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small, 
         Weekday = factor(Weekday, levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")),
         network = case_when(Site_ID == "CG" | Site_ID == "EP" | Site_ID == "WP" ~ "Temperate East",
                             Site_ID == "DNE" | Site_ID == "DSW" | Site_ID == "NGN"| Site_ID == "NGS" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west"))) |>
  filter(Total_ves_dep > 0) 

levels(all_ves_wkdy$Weekday) <- c("M","T","W","R","F","Sa","Su")


# function to calculate Agresti-Coull interval
# from https://towardsdatascience.com/five-confidence-intervals-for-proportions-that-you-should-know-about-7ff5484c024f
AgrestiInterval <- function(x, n, conf.level = 0.95){
 p <- (x+2)/(n+4)
 sd <- sqrt(p*((1-p)/(n+4)))
 z <- qnorm(c( (1 - conf.level)/2, 1- (1-conf.level)/2)) #returns the value of thresholds at which conf.level has to be cut at. for 95% CI, this is -1.96 and +1.96
 ci <- p + z*sd
 return(ci)
 }

wkdy_prop_table <- all_ves_wkdy |>
  group_by(network, npz_id, Site_ID, Dep) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small,
         tot_prop = Total_ves_dep/sum(Total_ves_dep),
         ins_prop = Total_inside/sum(Total_inside),
         small_prop = Total_inside_small/sum(Total_inside_small),
         ins_trans_prop = Inside_transit/sum(Inside_transit),
         small_trans_prop = Inside_transit_small/sum(Inside_transit_small),
         ins_man_prop = Inside_maneuver/sum(Inside_maneuver),
         small_man_prop = Inside_maneuver_small/sum(Inside_maneuver_small))

wkdy_prop_long <- wkdy_prop_table |>
  pivot_longer(cols = -c(network, npz_id, Site_ID, Dep, Weekday), 
               values_to = "Weekday_prop", names_to = "Ves_behav") |>
  filter(grepl("prop", Ves_behav)) |>
  # relevel categorical values for plotting
  mutate(Ves_behav = fct(Ves_behav),
         Ves_behav = fct_relevel(Ves_behav, c("tot_prop","small_prop", "ins_prop", "small_trans_prop","small_man_prop", "ins_trans_prop","ins_man_prop")),
         # network = fct(network),
         network = fct_relevel(network, c("Temperate East","Northwest")), 
         npz_id = fct(npz_id),
         npz_id = fct_relevel(npz_id, c("CGMP","SIMP","DMP","NMP")))



# TO DO:
# - calculate A-C confidence intervals for each proportion
# - add CI's to plot

```


Daily proportion of hours present, summarized by weekday
"For days with vessels present, what proportion of the day had vessels?
When those are summarized by Weekday, what's the median value for each weekday at each NPZ?"

```{r weekday proportion hours}
# 
# wkdy_prop_hr <- all_sites_hp |>
#   group_by() |>
#   mutate() |>
  


## Try individual npz's for a single network
## need to torubleshoot how these props are counted... might not be doing what I think it is
# looks like one value per deployment per weekday, but ideally would be boxplots of daily
# proportions summarized by weekday? i.e., should have a separate point for each time a weekday occurred
# e.g., if deployment was 4 weeks, Thursday might be {0.15, 0.11, 0.23, 0.20} vs. Monday = {0.01, 0.02, 0.01, 0.03}
# might need to do ves_yn by date, then summarize/group by weekday or something
# 
# ggplot(data = all_perc_weekday |> 
#          filter(ves_yn == "Y",
#                 !is.na(npz_id),
#                 network == "Temperate East"),
#        aes(x = Weekday,
#            y = Perc_per_hour,
#            fill = Dep,
#            color = Dep))+
#   geom_boxplot(
#     position = position_dodge2(preserve = "single"),
#     alpha = 0.75,
#     width = 0.5)+
#   scale_fill_viridis_d(end = 0.75,
#                        direction = -1
#   )+
#   scale_color_viridis_d(end = 0.75,
#                         direction = -1,
#                         guide = "none")+
#   facet_grid(rows = vars(npz_id),
#              drop = TRUE) +
#   labs(x = "Weekday",
#        y = "Proportion hours per weekday",
#        fill = "NPZ") +
#   theme(
#     strip.text.y = element_text(face = "bold"),
#     axis.text.y = element_text(face = "bold"),
#     axis.text.x = element_text(face = "bold")
#   )
# 
# ggsave(paste0("figs/", "Weekday_prop_hrs_npz_southwest.png"), width=6, height=10,
#        units="in", dpi=300)





```



## Plotting weekday proportions

```{r weekday plots}


wkday_prop_total <- wkdy_prop_long |>
  filter(Ves_behav == "tot_prop")

ggplot(data = wkday_prop_total |> filter (npz_id != "MMP"),
       aes(x = Weekday, 
           y = Weekday_prop)) +
  geom_col(aes(fill = network),
           position = position_dodge()) +
  scale_fill_viridis_d(end = 0.75, direction = -1)+
  labs(y = "Proportion", 
       x = "Weekday", 
       fill = "Network")+  
  facet_grid(rows = vars(npz_id)) +
   theme(
    axis.text.x = element_text(face = "bold"),
    strip.text.y = element_text(face = "bold")
    )



ggsave(paste0("figs/", "Weekday_props_npz.png"), width=8, height=10,
       units="in", dpi=300)




wkday_prop_ins <- wkdy_prop_long |>
  filter(Ves_behav == "ins_prop" | Ves_behav == "ins_trans_prop" | Ves_behav == "ins_man_prop")

ggplot(data = wkday_prop_ins |> filter (npz_id != "MMP" & npz_id != "SWCMP"),
       aes(x = Weekday, 
           y = Weekday_prop)) +
  geom_col(aes(fill = Ves_behav),
           position = position_dodge()) +
  scale_fill_viridis_d(end = 0.75, direction = -1)+
  labs(y = "Proportion", 
       x = "Weekday", 
       fill = "Network")+  
  facet_grid(rows = vars(npz_id),
             cols = vars(Ves_behav)) +
   theme(
    axis.text.x = element_text(face = "bold"),
    strip.text.y = element_text(face = "bold")
    )



ggsave(paste0("figs/", "Weekday_props_npz_inside.png"), width=8, height=10, units="in", dpi=300)






```







### Export CSV summary tables

```{r export tables}

# Total vessel presence
write_csv(all_ves_by_site, 
          file = "output/All_ves_by_dep.csv")
write_csv(all_ves_by_npz, 
          file = "output/All_ves_by_npz.csv")
write_csv(all_ves_wkdy, 
          file = "output/All_ves_by_weekday.csv")

```
