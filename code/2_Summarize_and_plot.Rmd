---
title: "AMP_ves_summary_plots"
author: "Jessica McCordic"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r load libraries and helper script, include=FALSE, message=FALSE, warning=FALSE, echo=FALSE}

#### Load libraries ####

# NOAA-approved tidyverse
tidyverse_short<-c("broom","cli","crayon","dbplyr","dplyr","dtplyr","forcats","ggplot2","googledrive","googlesheets4","hms","httr","jsonlite","lubridate","magrittr","modelr","pillar","purrr","readr","readxl","reprex","rlang","rstudioapi","rvest","stringr","tibble","tidyr","xml2") 
lapply(tidyverse_short, require, character.only = TRUE) 

library(scales)
# library(ggalt)
# library(ggsci)
library(ggdist)
library(ggh4x) # nested faceting
library(ggpubr) # additional options for publication plots
library(suncalc) # sunrise & sunset calculations
library(geosphere) 
library(ggpattern)
library(MuMIn) # AICc values
library(fmsb) # for pairwise fisher testing
library(suntools)

theme_set(theme_bw(
  base_size = 14
))

# source helper file
source("code/AMP_summary_ves_funs.R")
```

## Load hourly presence datasets

```{r Load data, include=FALSE}

#### Load compiled hourly presence table ####
# This is generated using Reformat_data_for_HP script

all_sites_hp <- read_csv("data/All_sites_tables/hourly_pres_allsites_local.csv")
all_sites_inout <- read_csv("data/All_sites_tables/total_ves_ins_out_by_site.csv")

##### Deployment info ###
depinfo <- read_csv("data/AMP_deployment_info.csv") |>
  # add Dep column for joining with other tables
  mutate(Dep = str_sub(PROJECT_NAME, 16, -1))



```

## Reshape data for plotting

```{r reshape tables, include = FALSE}

#### Add columns to original dataset to help group for plotting ####

all_sites_hp <- all_sites_hp |>
  mutate(
    # replace NA's with 0's to accurately incorporate hours with presence = 0
    Total_Vessels = replace_na(Total_Vessels, 0),
    total_inside = replace_na(total_inside, 0),
    total_inside_small = replace_na(total_inside_small, 0),
    
    # add categorical Y/N column for vessels present to calculate proportions
    ves_yn = ifelse(Total_Vessels == 0, "N","Y"),
    ins_ves_yn = ifelse(total_inside == 0, "N","Y"),
    ins_ves_small_yn = ifelse(total_inside_small == 0, "N","Y"),
    
    # fix incorrect Dep_ID for 2018_08
    Dep_ID = str_replace(Dep_ID, pattern = "2018-08-10", replacement = "201808"),
    
    # add date without year to collapse across years
    Month = month(Begin_Date_loc),
    Week = isoweek(Begin_Date_loc),
    Day_month = mday(Begin_Date_loc),
    # re-create dates as all in the same year for plotting on single graph
    Date_noyr = as_date(paste0("2000", "-", Month, "-", Day_month), format = "%Y-%m-%d"),
    # get start date for each week
    Date_week = as_date(paste(as.character(year(Begin_Date_loc)),Week,"1",sep = "-"), format = "%Y-%W-%w"),
    
    # add season based on month
    season = case_when(month(Date_noyr) == 12 | month(Date_noyr) == 1 | month(Date_noyr) == 2 ~ "Summer",
                       month(Date_noyr) == 3 | month(Date_noyr) == 4 | month(Date_noyr) == 5 ~ "Autumn",
                       month(Date_noyr) == 6 | month(Date_noyr) == 7 | month(Date_noyr) == 8 ~ "Winter",
                        TRUE ~ "Spring"
    ),
    
    # add AMP Regional Networks and NPZ IDs based on Site_ID
    network = case_when(Site_ID == "CG" | Site_ID == "EP" | Site_ID == "WP" ~ "Temperate East",
                        Site_ID == "DNE" | Site_ID == "DSW" | Site_ID == "NGN"| Site_ID == "NGS" ~ "Northwest",
                        TRUE ~ "South-west"
    ),
    npz_id = case_when(
      # Cod Grounds
      Site_ID == "CG" ~ "CGMP", 
      # Solitary Islands
      Site_ID == "EP" | Site_ID == "WP" ~ "SIMP",
      # Dampier
      Site_ID == "DNE" | Site_ID == "DSW" ~ "DMP",
      # Ningaloo
      Site_ID == "NGN"| Site_ID == "NGS" ~ "NMP", 
      # Two Rocks
      Site_ID == "TRE" | Site_ID == "TRW" ~ "TRMP", 
      # Jurien
      Site_ID == "JSE" | Site_ID == "JNE" ~ "JMP", 
      # Geographe
      Site_ID == "GEO" ~ "GMP",
      # Murat
      Site_ID == "MRE" | Site_ID == "MRW" ~ "MMP",
      # South-west Corner
      Site_ID == "SWS" ~ "SWCMP" 
    )
  )
# get coords from depinfo
dep_coords <- depinfo |>
  select(Dep, Lat_DD, Lon_DD)

# join coords to full df
all_sites_hp <- all_sites_hp |>
  left_join(dep_coords, by = "Dep")



```

## Recording effort and gaps

Add in gaps and dates with coverage 

```{r effort and gaps, include=FALSE}

# create table of data gaps within nominal year (2000)

gaps <- data.frame("Gap_start" = c(as.POSIXct("2000-02-20",format="%Y-%m-%d"), #CGMP gap 1 start
                                   as.POSIXct("2000-08-04",format="%Y-%m-%d"), #CGMP gap 2 start
                                   as.POSIXct("2000-06-24",format="%Y-%m-%d"), #CGMP gap 3 start
                                   as.POSIXct("2000-01-15",format="%Y-%m-%d"), #SIMP gap 1 start
                                   as.POSIXct("2000-09-12",format="%Y-%m-%d"), #SIMP gap 2 start
                                   as.POSIXct("2000-08-09",format="%Y-%m-%d"), #SIMP gap 3 start
                                   as.POSIXct("2000-01-01",format="%Y-%m-%d"), #DMP gap 1 start
                                   as.POSIXct("2000-11-04",format="%Y-%m-%d"), #DMP gap 2 start
                                   as.POSIXct("2000-01-01",format="%Y-%m-%d"), #NMP gap 1 start
                                   as.POSIXct("2000-11-18",format="%Y-%m-%d"), #NMP gap 2 start
                                   as.POSIXct("2000-01-01",format="%Y-%m-%d"), #GMP gap 1 start
                                   as.POSIXct("2000-04-03",format="%Y-%m-%d"), #GMP gap 2 start
                                   as.POSIXct("2000-01-01",format="%Y-%m-%d"), #JMP gap 1 start
                                   as.POSIXct("2000-03-10",format="%Y-%m-%d"), #JMP gap 2 start
                                   as.POSIXct("2000-01-01",format="%Y-%m-%d"), #MMP gap 1 start
                                   as.POSIXct("2000-05-03",format="%Y-%m-%d"), #MMP gap 2 start
                                   as.POSIXct("2000-01-01",format="%Y-%m-%d"), #SWCMP gap 1 start
                                   as.POSIXct("2000-04-11",format="%Y-%m-%d"), #SWCMP gap 2 start
                                   as.POSIXct("2000-01-01",format="%Y-%m-%d"), #TRMP gap 1 start
                                   as.POSIXct("2000-08-02",format="%Y-%m-%d") #TRMP gap 2 start
                                   ),
                                    
                   
                   "Gap_end" = c(as.POSIXct("2000-04-11",format="%Y-%m-%d"), #CGMP gap 1 end
                                   as.POSIXct("2000-12-12",format="%Y-%m-%d"), #CGMP gap 2 end
                                 as.POSIXct("2000-07-01",format="%Y-%m-%d"), #CGMP gap 3 end
                                   as.POSIXct("2000-06-10",format="%Y-%m-%d"), #SIMP gap 1 end
                                   as.POSIXct("2000-12-12",format="%Y-%m-%d"), #SIMP gap 2 end
                                 as.POSIXct("2000-08-10",format="%Y-%m-%d"), #SIMP gap 3 end
                                   as.POSIXct("2000-09-09",format="%Y-%m-%d"), #DMP gap 1 end
                                   as.POSIXct("2000-12-31",format="%Y-%m-%d"), #DMP gap 2 end
                                   as.POSIXct("2000-09-25",format="%Y-%m-%d"), #NMP gap 1 end
                                   as.POSIXct("2000-12-31",format="%Y-%m-%d"), #NMP gap 2 end
                                   as.POSIXct("2000-01-12",format="%Y-%m-%d"), #GMP gap 1 end
                                   as.POSIXct("2000-12-31",format="%Y-%m-%d"), #GMP gap 2 end
                                   as.POSIXct("2000-01-05",format="%Y-%m-%d"), #JMP gap 1 end
                                   as.POSIXct("2000-12-31",format="%Y-%m-%d"), #JMP gap 2 end
                                   as.POSIXct("2000-02-08",format="%Y-%m-%d"), #MMP gap 1 end
                                   as.POSIXct("2000-12-31",format="%Y-%m-%d"), #MMP gap 2 end
                                   as.POSIXct("2000-01-18",format="%Y-%m-%d"), #SWCMP gap 1 end
                                   as.POSIXct("2000-12-31",format="%Y-%m-%d"), #SWCMP gap 2 end
                                   as.POSIXct("2000-05-10",format="%Y-%m-%d"), #TRMP gap 1 end
                                   as.POSIXct("2000-12-31",format="%Y-%m-%d") #TRMP gap 2 end
                                 ),
                   
                   "npz_id" = c("CGMP",
                              "CGMP",
                              "CGMP",
                              "SIMP",
                              "SIMP",
                              "SIMP",
                              "DMP",
                              "DMP",
                              "NMP",
                              "NMP",
                              "GMP",
                              "GMP",
                              "JMP",
                              "JMP",
                              "MMP",
                              "MMP",
                              "SWCMP",
                              "SWCMP",
                              "TRMP",
                              "TRMP"))


dep_startend <- data.frame("dep_start" = c(as.POSIXct("2000-07-01",format="%Y-%m-%d"), #CGMP 201807 start
                                   as.POSIXct("2000-12-12",format="%Y-%m-%d"), #CGMP 201812 first part
                                   as.POSIXct("2000-01-01",format="%Y-%m-%d"), #CGMP 201812 second part
                                   as.POSIXct("2000-04-11",format="%Y-%m-%d"), #CGMP 201904 start
                                   as.POSIXct("2000-08-10",format="%Y-%m-%d"), #SIMP 201808 start
                                   as.POSIXct("2000-12-12",format="%Y-%m-%d"), #SIMP 201812 first part
                                   as.POSIXct("2000-01-01",format="%Y-%m-%d"), #SIMP 201812 second part
                                   as.POSIXct("2000-06-10",format="%Y-%m-%d"), #SIMP 201906 start
                                   as.POSIXct("2000-09-09",format="%Y-%m-%d"), #DMP start
                                   as.POSIXct("2000-09-25",format="%Y-%m-%d"), #NMP start
                                   as.POSIXct("2000-01-12",format="%Y-%m-%d"), #GMP start
                                   as.POSIXct("2000-01-05",format="%Y-%m-%d"), #JMP start
                                   as.POSIXct("2000-02-08",format="%Y-%m-%d"), #MMP start
                                   as.POSIXct("2000-01-18",format="%Y-%m-%d"), #SWCMP start
                                   as.POSIXct("2000-05-10",format="%Y-%m-%d") #TRMP start
                                   ),
                                    
                   
                   "dep_end" = c(as.POSIXct("2000-08-04",format="%Y-%m-%d"), #CGMP 201807 end
                                   as.POSIXct("2000-12-31",format="%Y-%m-%d"), #CGMP 201812 first part
                                   as.POSIXct("2000-02-20",format="%Y-%m-%d"), #CGMP 201812 second part
                                   as.POSIXct("2000-06-24",format="%Y-%m-%d"), #CGMP 201904 end
                                   as.POSIXct("2000-09-12",format="%Y-%m-%d"), #SIMP 201808 end
                                   as.POSIXct("2000-12-31",format="%Y-%m-%d"), #SIMP 201812 first part
                                   as.POSIXct("2000-01-15",format="%Y-%m-%d"), #SIMP 201812 second part
                                   as.POSIXct("2000-08-09",format="%Y-%m-%d"), #SIMP 201906 end
                                   as.POSIXct("2000-11-04",format="%Y-%m-%d"), #DMP end
                                   as.POSIXct("2000-11-18",format="%Y-%m-%d"), #NMP end
                                   as.POSIXct("2000-04-03",format="%Y-%m-%d"), #GMP end
                                   as.POSIXct("2000-03-10",format="%Y-%m-%d"), #JMP end
                                   as.POSIXct("2000-05-03",format="%Y-%m-%d"), #MMP end
                                   as.POSIXct("2000-04-11",format="%Y-%m-%d"), #SWCMP end
                                   as.POSIXct("2000-08-02",format="%Y-%m-%d") #TRMP end
                                   ),
                   
                   "npz_id" = c("CGMP",
                              "CGMP",
                              "CGMP",
                              "CGMP",
                              "SIMP",
                              "SIMP",
                              "SIMP",
                              "SIMP",
                              "DMP",
                              "NMP",
                              "GMP",
                              "JMP",
                              "MMP",
                              "SWCMP",
                              "TRMP"),
                   
                   "Dep_ID" = c("201807",
                              "201812",
                              "201812",
                              "201904",
                              "201808",
                              "201812",
                              "201812",
                              "201906",
                              "202009",
                              "201909",
                              "202201",
                              "202201",
                              "202002",
                              "202201",
                              "202105"))


gaps <- gaps |>
  mutate(network = case_when(npz_id == "CGMP" | npz_id == "SIMP" ~ "Temperate East",
                             npz_id == "DMP" | npz_id == "NMP" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west")))

dep_startend <- dep_startend |>
  mutate(network = case_when(npz_id == "CGMP" | npz_id == "SIMP" ~ "Temperate East",
                             npz_id == "DMP" | npz_id == "NMP" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west")))

gaps_wk <- gaps |>
  mutate(Gap_start = floor_date(Gap_start, "1 week"),
         Gap_end = floor_date(Gap_end, "1 week"))

```


## Data summary and visualization

### Total vessel presence per deployment

Raw total counts per deployments and vessels inside the NPZs
Deployment-level and NPZ-level info

```{r total presence, message=FALSE, warning=FALSE}

# summarize in-out data to get n vessels used for I-O analysis per deployment
ins_out_counts <- all_sites_inout |>
  group_by(Dep_ID) |>
  summarize(n_ves_used_inout = n()) |>
  rename("Dep" = "Dep_ID")

# summarize full df to get counts per deployment
all_ves_by_site <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep_ID, Dep) |>
  summarise(n_days = n_distinct(Begin_Date_loc),
            Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE),
            mean_per_day = Total_ves_dep/n_days,
            mean_overall = mean(Total_Vessels)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small) |>
  left_join(ins_out_counts, by = "Dep") |>
  mutate(
    prop_inside = Total_inside/n_ves_used_inout,
    total_outside = n_ves_used_inout - Total_inside,
    prop_inside_small = Total_inside_small/n_ves_used_inout,
    total_out_small = n_ves_used_inout - Total_inside_small)


all_ves_by_npz <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep_ID, Dep) |>
  left_join(ins_out_counts, by = "Dep") |>
  ungroup() |>
  group_by(network, npz_id, Dep_ID) |>
  summarise(n_days = n_distinct(Site_ID, Begin_Date_loc),
            Total_ves_npz = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE),
            mean_per_day = Total_ves_npz/n_days,
            
            n_used_inout = sum(unique(n_ves_used_inout)),
            
            mean_overall = mean(Total_Vessels),
           ) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small,
         total_outside = n_used_inout - Total_inside,
         total_out_small = n_used_inout - Total_inside_small,
         prop_inside = Total_inside/n_used_inout,
         prop_inside_small = Total_inside_small/sum(n_used_inout),
         prop_maneuver = Inside_maneuver/Total_inside,
         prop_maneuver_small = Inside_maneuver_small/Total_inside_small)



all_ves_long <- all_ves_by_site |>
  pivot_longer(cols = -c(network, npz_id, Site_ID, Dep_ID, Dep, n_days), 
               values_to = "Ves_counts", names_to = "Ves_behav") |>
  # relevel categorical values for plotting
  mutate(Ves_behav = fct(Ves_behav),
         Ves_behav = fct_relevel(Ves_behav, c("Total_ves_dep","Total_inside_small", "Total_inside", "Inside_transit_small","Inside_maneuver_small", "Inside_maneuver","Inside_transit")),
         network = fct(network),
         network = fct_relevel(network, c("Temperate East","Northwest"))) |>
  # add diverging counts where inside values are negative for plotting
  mutate(ves_counts_diverge = ifelse(Ves_behav == "Total_inside" | Ves_behav == "Inside_maneuver",Ves_counts*(-1),Ves_counts),
         npz_id = fct(npz_id),
         npz_id = fct_relevel(npz_id, c("CGMP","SIMP","DMP","NMP")))


all_ves_by_day <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep_ID, Dep, Date_week, Begin_Date_loc) |>
  summarise(n_hrs = n_distinct(Begin_Hour_loc),
            n_ves_hrs = sum(ifelse(ves_yn == "Y", 1, 0), na.rm = TRUE),
            Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE),
            # daily means
            mean_total_ves = mean(Total_Vessels),
            mean_ins_ves = mean(total_inside),
            mean_ins_sm_ves = mean(total_inside_small)) |>
  mutate(daily_ves_perhr = Total_ves_dep/n_hrs,
         total_prophr = n_ves_hrs/n_hrs,
        Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small)

all_ves_by_day_noyr <- all_sites_hp |>
  group_by(network, npz_id, 
           Site_ID,
           Dep_ID, 
           Dep,
           Date_week, Date_noyr) |>
  summarise(n_hrs = n_distinct(Begin_Hour_loc),
            n_ves_hrs = sum(ifelse(ves_yn == "Y", 1, 0), na.rm = TRUE),
            Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE),
            # daily means
            # mean_total_ves = mean(Total_Vessels),
            # mean_ins_ves = mean(total_inside),
            # mean_ins_sm_ves = mean(total_inside_small)
            ) |>
  filter(n_hrs > 23) |> # only include full days
  ungroup() |>
  # re-group to get counts pooled by NPZ
  group_by(network, npz_id,
           Dep_ID,
           Date_week, Date_noyr) |>
  summarise(n_hrs_tot = sum(n_hrs),
            n_ves_hrs_tot = sum(n_ves_hrs, na.rm = TRUE),
            Total_ves_npz = sum(Total_ves_dep, na.rm = TRUE),
            Total_inside_npz = sum(Total_inside, na.rm = TRUE),
            Total_inside_small_npz = sum(Total_inside_small, na.rm = TRUE),
            Inside_maneuver_npz = sum(Inside_maneuver, na.rm = TRUE),
            Inside_maneuver_small_npz = sum(Inside_maneuver_small, na.rm = TRUE)
  ) |>
  mutate(daily_ves_perhr = Total_ves_npz/n_hrs_tot*24, # ves/day = ves/hour * 24hr/day
         total_prophr = n_ves_hrs_tot/n_hrs_tot,
         Inside_transit_npz = Total_inside_npz - Inside_maneuver_npz,
         Inside_transit_small_npz = Total_inside_small_npz - Inside_maneuver_small_npz,
         network = case_when(npz_id == "CGMP" | npz_id == "SIMP" ~ "Temperate East",
                             npz_id == "DMP" | npz_id == "NMP" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west"))) 



```

### Plots by NPZ

Visualizing overall vessel presence

```{r plots by npz}

# weekly plots for nominal year
ggplot() +
  geom_boxplot(data = all_ves_by_day_noyr |> 
                 filter(daily_ves_perhr > 0),
       aes(x = as_date(Date_noyr),
           y = daily_ves_perhr, 
           group = as_date(Date_week),
           fill = network),
               show.legend = FALSE) + 
    geom_rect(data = gaps,
            aes(xmin = as_date(Gap_start),
                xmax = as_date(Gap_end),
                ymin = 0,
                ymax = 50),
            fill = "grey80",
            alpha = 0.7)+
  scale_x_date(date_breaks = "months", 
               date_labels = "%b")+
scale_fill_manual(values = c("Temperate East" = "#00AB8E",
                             "Northwest" = "#A05EB5",
                             "South-west" = "#485CC7"))+
  labs(y = "N vessels present / day",
       x = "Date")+
  facet_nested(rows = vars(network, npz_id), 
               nest_line = element_line(),
               scales = "free_x") +
    theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )
```

```{r save total boxplot}
ggsave(paste0("figs/", "Total_boxplot_counts_perday_1yr.png"), width=10, height=8,
       units="in", dpi=300)

```

### Dumbbell Plot for Overall Effort 

``` {r dumbbell timeline} 

ggplot() +
  geom_segment(data = dep_startend,
                aes(x = as_date(dep_start),
                    xend = as_date(dep_end),
                    y = 1.5,
                    color = network),
                linewidth = 4) +
  scale_color_manual(values = c("Temperate East" = "#00AB8E",
                             "Northwest" = "#A05EB5",
                             "South-west" = "#485CC7"))+
  geom_rect(data = gaps,
            aes(xmin = as_date(Gap_start),
                xmax = as_date(Gap_end),
                ymin = 0,
                ymax = 3),
            fill = "grey80",
            alpha = 0.8)+
  scale_x_date(date_breaks = "months", 
               date_labels = "%b",
               expand = c(0,0))+
  labs(x = "Date", 
       y = "",
       color = "Regional Network")+
  facet_nested(rows = vars(network, npz_id), 
               nest_line = element_line(),
               scales = "free", 
               space = "fixed",
               switch = "y") +
    theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold"),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank()
    )

```

```{r save effort plot}
ggsave(paste0("figs/", "Total_recording_effort_1yr.png"), width=12, height=8,
       units="in", dpi=300)

```




### Diverging bar plot by NPZ

Of vessels suitable for propagation analysis, what proportion are estimated to occur within the NPZ boundaries?

```{r div bar by npz colors}

####
# Diverging bar plot - NPZ (with colors!)
#### 


breakvals <- seq(-200, 800, 200)

ggplot() +
  geom_col(data = all_ves_long |> 
         filter(Ves_behav == "total_outside",
               npz_id != "SWCMP"),
        aes(x = npz_id,
           y = ves_counts_diverge),
         position = position_stack(reverse = TRUE),
           fill = "grey75",
        show.legend = FALSE
         )+
  geom_col(data = all_ves_long |> 
         filter(Ves_behav == "Total_inside",
               npz_id != "SWCMP"),
         aes(x = npz_id,
           y = ves_counts_diverge,
           fill = network),
    position = position_stack(reverse = TRUE),
    # pattern_key_scale_factor = 1.3,
    # pattern = "circle",
    # pattern_density = 0.05,
    # fill = "grey80",
    # pattern_fill = "black",
    # pattern_colour = NA,
    show.legend = FALSE
                   ) +
  guides(fill = "none", alpha = "none")+ # take away fill legend but keep alpha legend
  coord_flip()+
  scale_y_continuous(limits = c(-200, 800),
                     breaks = breakvals, 
                     labels = abs(breakvals))+
  scale_fill_manual(values = c("Temperate East" = "#00AB8E",
                             "Northwest" = "#A05EB5",
                             "South-west" = "#485CC7"))+
  # scale_pattern_fill_manual(values = c("Temperate East" = "#00AB8E",
  #                            "Northwest" = "#A05EB5",
  #                            "South-west" = "#485CC7"))+
  # scale_color_manual(values = c("Temperate East" = "#00AB8E",
  #                            "Northwest" = "#A05EB5",
  #                            "South-west" = "#485CC7"))+
  scale_alpha_manual(values = c(0.9,0.4),
                       labels = c("Inside" , "Outside"))+
  labs(y = "N vessels",
       # alpha = "Estimated vessel location",
       title = "",
       fill = NULL) +
  facet_nested(rows = vars(network, npz_id, Dep_ID), 
               nest_line = element_line(),
               scales = "free_y",
               switch = "y") +
  theme(
    axis.text.x = element_text(face = "bold"),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )
```

```{r save div bar fig}
ggsave(paste0("figs/", "Ins_out_counts_npz_colors_gray.png"), width=10, height=8,
       units="in", dpi=300)

```



### Diverging bar plot transit vs maneuver

Similar to plot above but for transit vs. maneuver instead of inside vs. outside

```{r div plot maneuvers colors}

breakvals_trans <- seq(-100,50,25)
ggplot(data = all_ves_long |>
         filter(Ves_behav == "Inside_transit" |
               Ves_behav == "Inside_maneuver",
               npz_id != "SWCMP",
               npz_id != "MMP")) +
  geom_col(aes(x = npz_id,
           y = ves_counts_diverge,
           alpha = Ves_behav,
           fill = network),
           position = position_stack(),
           show.legend = FALSE) +
  # geom_col_pattern(aes(x = npz_id,
  #          y = ves_counts_diverge), 
  #          position = position_stack(),
  #                  pattern_density = 0.1,
  #   fill = NA,
  #   pattern_fill = "black",
  #   pattern_colour = NA,
  #   show.legend = FALSE)+
  coord_flip()+
  scale_y_continuous(limits = c(-75, 50),
                     breaks = breakvals_trans,
                     labels = abs(breakvals_trans))+
   scale_fill_manual(values = c("Temperate East" = "#00AB8E",
                             "Northwest" = "#A05EB5",
                             "South-west" = "#485CC7"))+
  scale_alpha_manual(values = c(0.9, 0.3), labels = c("Maneuver","Transit"))+
  labs(y = "N vessels",
       alpha = "Vessel Behavior",
       title = "",
       fill = NULL) +
  facet_nested(rows = vars(network, npz_id, Dep_ID),
               nest_line = element_line(),
               scales = "free_y",
               switch = "y") +
  theme(
    axis.text.x = element_text(face = "bold"),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )
```


```{r save trans-man plot}
ggsave(paste0("figs/", "Transit_maneuver_counts_color_npz.png"), width=10, height=8,
       units="in", dpi=300)

```



## Test proportions across NPZs

```{r fisher tests}

# Proportion inside

# test across NPZs

inout_freq_table <- all_ves_long |>
  mutate(npz_dep = paste0(npz_id, Dep_ID)) |>
  filter(Ves_behav == "Total_inside" | Ves_behav == "total_outside") |>
  group_by(npz_dep, Ves_behav) |> 
  summarise(total = sum(Ves_counts)) |>
  pivot_wider(names_from = Ves_behav,
              values_from = total)|>
  mutate(total_vessels = sum(Total_inside, total_outside),
    prop_inside = Total_inside/total_outside)

fisher.test(inout_freq_table[2:3], simulate.p.value = TRUE)
# data:  inout_freq_table[2:3]
# p-value = 0.0004998
# alternative hypothesis: two.sided




# Proportion inside: Post hoc pairwise comparisons with Bonferonni correction 


pairwise.fisher.test(x=inout_freq_table$Total_inside, n=inout_freq_table$total_vessels, p.adjust.method = "bonf")

# 	Pairwise comparisons using Pairwise comparison of proportions (Fisher) 
# 
# data:  inout_freq_table$Total_inside out of inout_freq_table$total_vessels 
 
#    1       2       3       4       5       6       7       8       9       10      11      12     
# 2  1.00000 -       -       -       -       -       -       -       -       -       -       -      
# 3  1.00000 1.00000 -       -       -       -       -       -       -       -       -       -      
# 4  0.02460 0.64093 0.06302 -       -       -       -       -       -       -       -       -      
# 5  < 2e-16 5.5e-13 < 2e-16 0.02166 -       -       -       -       -       -       -       -      
# 6  0.00019 0.04629 0.00028 1.00000 0.00014 -       -       -       -       -       -       -      
# 7  1.00000 1.00000 1.00000 1.00000 1.00000 1.00000 -       -       -       -       -       -      
# 8  0.00285 0.10991 0.00843 1.00000 0.70579 1.00000 1.00000 -       -       -       -       -      
# 9  0.09768 0.00179 0.00510 1.1e-07 < 2e-16 3.7e-12 1.00000 1.9e-08 -       -       -       -      
# 10 1.00000 1.00000 1.00000 0.38032 8.3e-15 0.01061 1.00000 0.06187 0.00151 -       -       -      
# 11 0.53075 0.00530 0.01473 2.2e-07 < 2e-16 6.7e-14 1.00000 3.3e-08 1.00000 0.00433 -       -      
# 12 1.7e-14 6.6e-11 1.7e-14 0.02455 1.00000 0.00043 1.00000 0.54677 < 2e-16 6.1e-12 < 2e-16 -      
# 13 5.7e-05 0.05522 0.00010 1.00000 9.9e-08 1.00000 1.00000 1.00000 1.8e-13 0.00702 < 2e-16 3.0e-06
# 
# P value adjustment method: bonferroni 


# proportion maneuvers

maneuver_freq_table <- all_ves_long |>
  mutate(npz_dep = paste0(npz_id, Dep_ID)) |>
  filter(Ves_behav == "Inside_transit" | Ves_behav == "Inside_maneuver") |>
  group_by(npz_dep, Ves_behav) |> 
  summarise(total = sum(Ves_counts)) |>
  pivot_wider(names_from = Ves_behav,
              values_from = total)|>
  mutate(total_inside = sum(Inside_transit, Inside_maneuver),
    prop_maneuver = Inside_maneuver/total_inside)

fisher.test(maneuver_freq_table[2:3], simulate.p.value = TRUE)
# data:  maneuver_freq_table[2:3]
# p-value = 0.004998
# alternative hypothesis: two.sided

# Proportion maneuvers: Post hoc pairwise comparisons with Bonferonni correction 


pairwise.fisher.test(x=maneuver_freq_table$Inside_maneuver, n=maneuver_freq_table$total_inside, p.adjust.method = "bonf")


# 	Pairwise comparisons using Pairwise comparison of proportions (Fisher) 
# 
# data:  maneuver_freq_table$Inside_maneuver out of maneuver_freq_table$total_inside 
# 
#    1       2      3      4      5      6       7      8      9       10     11     12    
# 2  1.0000  -      -      -      -      -       -      -      -       -      -      -     
# 3  1.0000  1.0000 -      -      -      -       -      -      -       -      -      -     
# 4  1.0000  1.0000 1.0000 -      -      -       -      -      -       -      -      -     
# 5  1.0000  1.0000 1.0000 1.0000 -      -       -      -      -       -      -      -     
# 6  1.0000  0.0170 0.0556 1.0000 1.0000 -       -      -      -       -      -      -     
# 7  1.0000  1.0000 1.0000 1.0000 1.0000 1.0000  -      -      -       -      -      -     
# 8  1.0000  1.0000 1.0000 1.0000 1.0000 1.0000  1.0000 -      -       -      -      -     
# 9  1.0000  0.1660 0.5726 1.0000 1.0000 1.0000  1.0000 1.0000 -       -      -      -     
# 10 0.1562  1.0000 1.0000 1.0000 1.0000 0.0025  1.0000 1.0000 0.0133  -      -      -     
# 11 1.0e-07 0.3149 0.0015 0.4112 1.0000 2.8e-09 1.0000 1.0000 1.0e-09 0.7308 -      -     
# 12 1.0000  1.0000 1.0000 1.0000 1.0000 1.0000  1.0000 1.0000 1.0000  1.0000 1.0000 -     
# 13 4.2e-05 1.0000 0.0834 1.0000 1.0000 5.4e-07 1.0000 1.0000 1.2e-06 1.0000 1.0000 1.0000
# 
# P value adjustment method: bonferroni 


```



## Temporal patterns

### Weekly mean-adjusted weekday presence

Calculate mean-adjusted totals per weekday, similar to Moussoline et al. 2012 diel presence

- For all full weeks (7d), Calculate weekly mean of daily totals per deployment
- For each weekday, calculate [daily total - weekly mean]
- values will be +/- relative to weekly mean

For weeks with vessel presence, the mean-adjusted weekday counts were highest in ___ NPZ on __day. Multiple NPZs showed higher presence on __days overall. 


```{r weekday mean adjusted}

# start by getting daily counts
all_ves_wkdy <- all_sites_hp |>
  group_by(network, npz_id, Dep_ID, Dep, Date_week, Weekday, Begin_Date_loc)|>
  # get daily vessel counts per weekday: total, inside, inside_small, maneuver, maneuver_small
  summarise(Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small, 
         Weekday = factor(Weekday, levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")),
         network = case_when(npz_id == "CGMP" | npz_id == "SIMP" ~ "Temperate East",
                             npz_id == "DMP" | npz_id == "NMP" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west"))) 
levels(all_ves_wkdy$Weekday) <- c("M","T","W","Th","F","Sa","Su")



# Weekly mean-adjusted counts for total vessels
wkly_mean_adj_tot <- all_ves_wkdy |>
  # group to week level
  group_by(network, npz_id, Dep_ID, Dep, Date_week) |>
  # get n_days per week in dataset
  summarize(n_days = n(),
            week_sum = sum(Total_ves_dep, na.rm = TRUE)) |>
  # only keep full weeks n_days == 7
  # only keep weeks with presence
  filter(n_days == 7,
         week_sum > 0) |>
  # get original weekday counts
  left_join(all_ves_wkdy) |>
  # re-group to week level
  group_by(network, npz_id, Dep_ID, Dep, Date_week) |>
  # calculate weekly mean of total presence for days with presence
  mutate(mean_tot = mean(Total_ves_dep, na.rm = TRUE),
         # calculate mean-adjusted counts per weekday
         tot_wkdy_adj = Total_ves_dep - mean_tot) 

# summarize mean & SD for plots
wkly_means_tot <- wkly_mean_adj_tot |>
  group_by(network, npz_id, Dep_ID, Weekday) |>
  # get mean of mean-adjusted counts for each weekday
  summarise(mean_wkdy_adj = mean(tot_wkdy_adj, na.rm = TRUE)) |>
  # get lower & upper bounds of SD of the mean of the adjusted counts
  mutate(sd_lower = mean_wkdy_adj - 0.5*(sd(mean_wkdy_adj)),
         sd_upper = mean_wkdy_adj + 0.5*(sd(mean_wkdy_adj)))




# Weekly mean-adjusted counts, inside vessels
wkly_mean_adj_ins <- all_ves_wkdy |>
  # group to week level
  group_by(network, npz_id, Dep_ID, Dep, Date_week) |>
  # get n_days per week in dataset
  summarize(n_days = n(),
            week_sum = sum(Total_inside, na.rm = TRUE)) |>
  # only keep full weeks n_days == 7
  # only keep weeks with presence inside
  filter(n_days == 7,
         week_sum > 0) |>
  # get original weekday counts
  left_join(all_ves_wkdy) |>
  # re-group to week level
  group_by(network, npz_id, Dep_ID, Dep, Date_week) |>
  # calculate weekly mean of total presence inside for days with presence inside
  mutate(mean_tot = mean(Total_inside, na.rm = TRUE),
         # calculate mean-adjusted counts per weekday
         tot_wkdy_adj = Total_inside - mean_tot) 
  
  wkly_means_ins <- wkly_mean_adj_ins |>
  group_by(network, npz_id, Dep_ID, Weekday) |>
  # get mean of mean-adjusted counts for each weekday
  summarise(mean_wkdy_adj = mean(tot_wkdy_adj, na.rm = TRUE)) |>
  # get lower & upper bounds of SD of the mean of the adjusted counts
  mutate(sd_lower = mean_wkdy_adj - 0.5*(sd(mean_wkdy_adj)),
         sd_upper = mean_wkdy_adj + 0.5*(sd(mean_wkdy_adj)))


# Weekly mean-adjusted counts, maneuvers
wkly_mean_adj_ins_man <- all_ves_wkdy |>
  # group to week level
  group_by(network, npz_id, Dep_ID, Dep, Date_week) |>
  # get n_days per week in dataset
  summarize(n_days = n(),
            week_sum = sum(Inside_maneuver, na.rm = TRUE)) |>
  # only keep full weeks n_days == 7
  # only keep weeks with presence of maneuvers
  filter(n_days == 7,
         week_sum > 0) |>
  # get original weekday counts
  left_join(all_ves_wkdy) |>
  # re-group to week level
  group_by(network, npz_id, Dep_ID, Dep, Date_week) |>
  # calculate weekly mean of total presence for days with presence of maneuvers
  mutate(mean_man = mean(Inside_maneuver, na.rm = TRUE),
         # calculate mean-adjusted counts per weekday
         man_wkdy_adj = Inside_maneuver - mean_man)
  
  
  wkly_means_ins_man <- wkly_mean_adj_ins_man |>
  group_by(network, npz_id, Dep_ID, Weekday) |>
  # get mean of mean-adjusted counts for each weekday
  summarise(mean_man_wkdy_adj = mean(man_wkdy_adj, na.rm = TRUE)) |>
  # get lower & upper bounds of SD of the mean of the adjusted counts
  mutate(man_sd_lower = mean_man_wkdy_adj - 0.5*(sd(mean_man_wkdy_adj)),
         man_sd_upper = mean_man_wkdy_adj + 0.5*(sd(mean_man_wkdy_adj)))



```

### Weekday 2-way ANOVA

```{r weekday anovas}

# total counts

wkly_mean_adj_tot <- wkly_mean_adj_tot |>
  mutate(npz_dep = as_factor(paste0(npz_id, Dep_ID)))

# deployment*Weekday
week_aov_int <- aov(tot_wkdy_adj ~ npz_dep*Weekday, 
                data = wkly_mean_adj_tot)

summary(week_aov_int)

# sanity check about npz_dep main effect
ggplot(data = wkly_mean_adj_tot, aes(x = npz_dep, y = tot_wkdy_adj)) + 
  geom_point(position = position_jitter(width = 0.1)) + 
  geom_boxplot(alpha = 0.8)
# makes sense that site contributed no variation since scores are all centered around 0

# Tukey HSD for interaction model

tukey_week <- tidy(TukeyHSD(week_aov_int)) |>
  filter(adj.p.value <= 0.05)



# inside vessels

wkly_mean_adj_ins <- wkly_mean_adj_ins |>
  mutate(npz_dep = as_factor(paste0(npz_id, Dep_ID)))

# 2-way ANOVA deployment*Weekday
week_ins_aov_int <- aov(tot_wkdy_adj ~ npz_dep*Weekday, 
                data = wkly_mean_adj_ins)

summary(week_ins_aov_int)


# Tukey HSD for interaction model

tukey_week_ins <- tidy(TukeyHSD(week_ins_aov_int)) |>
  filter(adj.p.value <= 0.05)



# maneuvers
wkly_mean_adj_ins_man <- wkly_mean_adj_ins_man |>
  mutate(npz_dep = as_factor(paste0(npz_id, Dep_ID)))

# 2-way ANOVA deployment*Weekday
week_man_aov_int <- aov(man_wkdy_adj ~ npz_dep*Weekday, 
                data = wkly_mean_adj_ins_man)

summary(week_man_aov_int)

# Tukey for interaction model
tukey_week_man <- tidy(TukeyHSD(week_man_aov_int)) |>
  filter(adj.p.value <= 0.05)

ggplot(data = wkly_mean_adj_ins_man, aes(x = Weekday, y = man_wkdy_adj)) + 
  geom_point(position = position_jitter(width = 0.1)) + 
  geom_boxplot(alpha = 0.8)

```



### Plot weekday mean-adjusted counts -- Total & Inside

```{r weekday ggarranged}
# Use ggarrange to make multipanel plot
wkdy_plot_tempeast <- ggplot(data = wkly_means_tot |> 
                               filter(network == "Temperate East"),
                             aes(x = Weekday, y = mean_wkdy_adj)) +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  
  # Pointrange for total vessels
  geom_linerange(aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id
  ),
  color = "grey50",
  # size = 0.05,
  show.legend = FALSE) +
  
  # Linerange for error bars on inside vessels
  geom_linerange(data = wkly_means_ins |> 
                    filter(network == "Temperate East"), 
                  aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id),
                  color = "black",                
                  # size = 0.1,
                  show.legend = FALSE
  )+
  # bars for inside vessels
  geom_col(data = wkly_means_ins |> 
             filter(network == "Temperate East"),
           aes(x = Weekday, 
               y = mean_wkdy_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               fill = ifelse(sd_lower >= 0, 'over',
                             ifelse(sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE
  )+
  
  # translucent bar for total vessels
  geom_col(data = wkly_means_tot |> 
             filter(network == "Temperate East"),
           aes(x = Weekday, 
               y = mean_wkdy_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               # fill = ifelse(sd_lower >= 0, 'over',
               #               ifelse(sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE,
           alpha = 0.15,
           fill = "grey50"
  )+
  
  
  # assign specific colors to values over/under mean
  scale_fill_manual(values = c("over" = "deepskyblue3", 
                               "under" = "orange",
                               "center" = "grey50"))+
  labs(y = "Mean-adjusted average N vessels / weekday",
       x = "Weekday")+
  facet_nested(rows = vars(npz_id, Dep_ID),
               # cols = vars(network),
               nest_line = element_line(),
               scales = "fixed") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold"),
    plot.margin = margin(t = 20, b = 5.5, l = 5.5)
  )



wkdy_plot_northwest <- ggplot(data = wkly_means_tot |> 
                               filter(network == "Northwest"),
                             aes(x = Weekday, y = mean_wkdy_adj)) +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  # geom_line(aes(group = Dep_ID),
  #           color = "grey50")+
  geom_linerange(aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id
  ),
  color = "grey50",
  # size = 0.05,
  show.legend = FALSE) +
  
  #linerange for inside error bars
   geom_linerange(data = wkly_means_ins |> 
                    filter(network == "Northwest"), 
                  aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id),
                  color = "black",                
                  # size = 0.1,
                  show.legend = FALSE
  )+
  
  # bars for inside vessels
  geom_col(data = wkly_means_ins |> 
             filter(network == "Northwest"),
           aes(x = Weekday, 
               y = mean_wkdy_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               fill = ifelse(sd_lower >= 0, 'over',
                             ifelse(sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE
  )+
 
  
  # translucent bar for total vessels
  geom_col(data = wkly_means_tot |> 
             filter(network == "Northwest"),
           aes(x = Weekday, 
               y = mean_wkdy_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               # fill = ifelse(sd_lower >= 0, 'over',
               #               ifelse(sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE,
           alpha = 0.15,
           fill = "grey50"
  )+
  # assign specific colors to values over/under mean
  scale_fill_manual(values = c("over" = "deepskyblue3", 
                               "under" = "orange",
                               "center" = "grey50"))+
  labs(y = "",
       x = "Weekday")+
  facet_nested(rows = vars(npz_id, Dep_ID),
               # cols = vars(network),
               nest_line = element_line(),
               scales = "fixed") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold"),
    plot.margin = margin(t = 20, b = 356)
    )


wkdy_plot_southwest <- ggplot(data = wkly_means_tot |> 
                               filter(network == "South-west"),
       aes(x = Weekday, y = mean_wkdy_adj)) +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  
  #linerange for total error bars
  geom_linerange(aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id
                      ),
                  color = "grey50",
                  # size = 0.05,
                  show.legend = FALSE) +
  
  # linerange for inside error bars
  geom_linerange(data = wkly_means_ins |> 
                    filter(network == "South-west"), 
                  aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id),
                  color = "black",                
                  # size = 0.1,
                  show.legend = FALSE
  )+
  # bars for inside vessels
  geom_col(data = wkly_means_ins |> 
             filter(network == "South-west"),
           aes(x = Weekday, 
               y = mean_wkdy_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               fill = ifelse(sd_lower >= 0, 'over',
                             ifelse(sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE
  )+
  #translucent bar for total vessels
  geom_col(data = wkly_means_tot |> 
             filter(network == "South-west"),
           aes(x = Weekday, 
               y = mean_wkdy_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               # fill = ifelse(sd_lower >= 0, 'over',
               #               ifelse(sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE,
           alpha = 0.15,
           fill = "grey50"
  )+
  
  # assign specific colors to values over/under mean
  scale_fill_manual(values = c("over" = "deepskyblue3", 
                               "under" = "orange",
                               "center" = "grey50"))+
  labs(y = "",
       x = "Weekday")+
  facet_nested(rows = vars(npz_id, Dep_ID),
               # cols = vars(network),
               nest_line = element_line(),
               scales = "fixed") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold"),
    plot.margin = margin(t = 20, r = 5.5, b = 93)
    )


ggarrange(wkdy_plot_tempeast, wkdy_plot_northwest, wkdy_plot_southwest,
          nrow = 1, 
          labels = c("Temperate East","Northwest","South-west"),
          vjust=1.25)
```

```{r save ggarranged weekday plot}
ggsave(paste0("figs/", "Weekday_mean_adj_horiz_panels_allbars.png"), width=12, height=8, units="in", dpi=300)

```

### Plot weekday mean-adjusted counts -- Inside & maneuvers

```{r weekday maneuvers ggarranged}
# Use ggarrange to make multipanel plot
wkdy_plot_man_tempeast <- ggplot() +

  
  # Linerange for error bars on inside vessels
  geom_linerange(data = wkly_means_ins_man |> 
                    filter(network == "Temperate East"), 
                  aes(x = Weekday,
                      y = mean_man_wkdy_adj,
                      ymin = man_sd_lower,
                      ymax = man_sd_upper,
                      group = npz_id),
                  color = "black",                
                  # size = 0.1,
                  show.legend = FALSE
  )+
  # bars for maneuvering vessels
  geom_col(data = wkly_means_ins_man |> 
             filter(network == "Temperate East"),
           aes(x = Weekday, 
               y = mean_man_wkdy_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               fill = ifelse(man_sd_lower >= 0, 'over',
                             ifelse(man_sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE
  )+  
  # dotted line to show 0
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  # Pointrange for inside vessels
  # geom_pointrange(data = wkly_means_ins |> 
  #                              filter(network == "Temperate East"),
  #                 aes(x = Weekday,
  #                     y = mean_wkdy_adj,
  #                     ymin = sd_lower,
  #                     ymax = sd_upper,
  #                     group = npz_id
  # ),
  # color = "grey50",
  # size = 0.05,
  # show.legend = FALSE) +
  # 
  
  # assign specific colors to values over/under mean
  scale_fill_manual(values = c("over" = "deepskyblue", 
                               "under" = "orange",
                               "center" = "grey75"))+
  scale_y_continuous(limits = c(-1.5,2.5))+
  labs(y = "Mean-adjusted average N vessels / weekday",
       x = "Weekday")+
  facet_nested(rows = vars(npz_id, Dep_ID),
               # cols = vars(network),
               nest_line = element_line(),
               scales = "fixed") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold"),
    plot.margin = margin(t = 20, b = 5.5, l = 5.5)
  )



wkdy_plot_man_northwest <- ggplot() +
 
  # Linerange for error bars on inside vessels
  geom_linerange(data = wkly_means_ins_man |> 
                    filter(network == "Northwest"), 
                  aes(x = Weekday,
                      y = mean_man_wkdy_adj,
                      ymin = man_sd_lower,
                      ymax = man_sd_upper,
                      group = npz_id),
                  color = "black",                
                  # size = 0.1,
                  show.legend = FALSE
  )+
  # bars for maneuvering vessels
  geom_col(data = wkly_means_ins_man |> 
             filter(network == "Northwest"),
           aes(x = Weekday, 
               y = mean_man_wkdy_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               fill = ifelse(man_sd_lower >= 0, 'over',
                             ifelse(man_sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE
  )+ 
  
  # dotted line to show 0
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  
  # Pointrange for inside vessels
  # geom_pointrange(data = wkly_means_ins |> 
  #                              filter(network == "Northwest"),
  #                 aes(x = Weekday,
  #                     y = mean_wkdy_adj,
  #                     ymin = sd_lower,
  #                     ymax = sd_upper,
  #                     group = npz_id
  # ),
  # color = "grey50",
  # size = 0.05,
  # show.legend = FALSE) +
  # 
  
  # assign specific colors to values over/under mean
  scale_fill_manual(values = c("over" = "deepskyblue", 
                               "under" = "orange",
                               "center" = "grey75"))+
    scale_y_continuous(limits = c(-1.5,2.5))+
  labs(y = "",
       x = "Weekday")+
  facet_nested(rows = vars(npz_id, Dep_ID),
               # cols = vars(network),
               nest_line = element_line(),
               scales = "fixed") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold"),
    plot.margin = margin(t = 20, b = 356)
    )


wkdy_plot_man_southwest <- ggplot() +
  
  # Linerange for error bars on inside vessels
  geom_linerange(data = wkly_means_ins_man |> 
                    filter(network == "South-west"), 
                  aes(x = Weekday,
                      y = mean_man_wkdy_adj,
                      ymin = man_sd_lower,
                      ymax = man_sd_upper,
                      group = npz_id),
                  color = "black",                
                  # size = 0.1,
                  show.legend = FALSE
  )+
  # bars for maneuvering vessels
  geom_col(data = wkly_means_ins_man |> 
             filter(network == "South-west"),
           aes(x = Weekday, 
               y = mean_man_wkdy_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               fill = ifelse(man_sd_lower >= 0, 'over',
                             ifelse(man_sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE
  )+
  # dotted line to show 0
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  # Pointrange for inside vessels
  # geom_pointrange(data = wkly_means_ins |> 
  #                              filter(network == "South-west"),
  #                 aes(x = Weekday,
  #                     y = mean_wkdy_adj,
  #                     ymin = sd_lower,
  #                     ymax = sd_upper,
  #                     group = npz_id
  # ),
  # color = "grey50",
  # size = 0.05,
  # show.legend = FALSE) +
  
  
  # assign specific colors to values over/under mean
  scale_fill_manual(values = c("over" = "deepskyblue", 
                               "under" = "orange",
                               "center" = "grey75"))+
    scale_y_continuous(limits = c(-1.5,2.5))+
  labs(y = "",
       x = "Weekday")+
  facet_nested(rows = vars(npz_id, Dep_ID),
               # cols = vars(network),
               nest_line = element_line(),
               scales = "fixed") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold"),
    plot.margin = margin(t = 20, r = 5.5, b = 356)
    )


ggarrange(wkdy_plot_man_tempeast, wkdy_plot_man_northwest, wkdy_plot_man_southwest,
          nrow = 1, 
          labels = c("Temperate East","Northwest","South-west"),
          vjust=1.25)
```

```{r save ggarranged weekday maneuver plot}
ggsave(paste0("figs/", "Weekday_mean_adj_horiz_panels_bars_maneuver.png"), width=12, height=8, units="in", dpi=300)

```


### Daily mean-adjusted diel presence

```{r mean adj diel}
# start by getting hourly counts
all_ves_diel <- all_sites_hp |>
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc, Begin_Hour_loc)|>
  # get daily vessel counts per weekday: total, inside, inside_small, maneuver, maneuver_small
  summarise(Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small, 
         network = case_when(npz_id == "CGMP" | npz_id == "SIMP" ~ "Temperate East",
                             npz_id == "DMP" | npz_id == "NMP" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west"))) 


# Calculate daily mean-adjusted counts per hour
daily_means_tot <- all_ves_diel |>
  # group to date level
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
  # get n_hours per day
  summarize(n_hrs = n(),
            # and total vessels per day
            day_sum = sum(Total_ves_dep, na.rm = TRUE)) |>
  # only keep full days n_hrs == 24
  # and days with vessels present
  filter(n_hrs == 24,
         day_sum >0) |>
  # join to get hourly counts back
  left_join(all_ves_diel) |>
  # re-group to daily level
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
  # calculate mean total presence per day with vessels
  mutate(mean_tot = mean(Total_ves_dep, na.rm = TRUE),
         # calculate mean-adjusted counts per hour
         tot_diel_adj = Total_ves_dep - mean_tot) |>
  # group to hour level per deployment
  group_by(network, npz_id, Dep_ID, Begin_Hour_loc) |>
  # get mean of mean-adjusted ounts per hour
  summarise(mean_diel_adj = mean(tot_diel_adj, na.rm =TRUE)) |>
  # get lower & upper bounds for SD around mean of adjusted counts
  mutate(sd_lower = mean_diel_adj - 0.5*(sd(mean_diel_adj)),
         sd_upper = mean_diel_adj + 0.5*(sd(mean_diel_adj)))
  


# Calculate daily mean-adjusted counts per hour for inside vessels
daily_means_ins <- all_ves_diel |>
  # group to date level
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
  # get n_hours per day
  summarize(n_hrs = n(),
            # and total vessels per day
            day_sum = sum(Total_inside, na.rm = TRUE)) |>
  # only keep full days n_hrs == 24
  # and days with vessels present
  filter(n_hrs == 24,
         day_sum > 0) |>
  # join to get hourly counts back
  left_join(all_ves_diel) |>
  # re-group to daily level
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
  # calculate mean total presence per day with vessels
  mutate(mean_ins = mean(Total_inside, na.rm = TRUE),
         # calculate mean-adjusted counts per hour
         ins_diel_adj = Total_inside - mean_ins) |>
  # group to hour level per deployment
  group_by(network, npz_id, Dep_ID, Begin_Hour_loc) |>
  # get mean of mean-adjusted ounts per hour
  summarise(mean_diel_adj = mean(ins_diel_adj, na.rm =TRUE)) |>
  # get lower & upper bounds for SD around mean of adjusted counts
  mutate(sd_lower = mean_diel_adj - 0.5*(sd(mean_diel_adj)),
         sd_upper = mean_diel_adj + 0.5*(sd(mean_diel_adj)))



# Calculate diel mean-adusted counts for maneuvers

daily_means_ins_man <- all_ves_diel |>
  # group to date level
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
  # get n_hours per day
  summarize(n_hrs = n(),
            # and total vessels per day
            day_sum = sum(Inside_maneuver, na.rm = TRUE)) |>
  # only keep full days n_hrs == 24
  # and days with vessels present
  filter(n_hrs == 24,
         day_sum > 0) |>
  # join to get hourly counts back
  left_join(all_ves_diel) |>
  # re-group to daily level
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
  # calculate mean total presence per day with vessels
  mutate(mean_ins_man = mean(Inside_maneuver, na.rm = TRUE),
         # calculate mean-adjusted counts per hour
         ins_diel_man_adj = Inside_maneuver - mean_ins_man) |>
  # group to hour level per deployment
  group_by(network, npz_id, Dep_ID, Begin_Hour_loc) |>
  # get mean of mean-adjusted ounts per hour
  summarise(mean_diel_man_adj = mean(ins_diel_man_adj, na.rm =TRUE)) |>
  # get lower & upper bounds for SD around mean of adjusted counts
  mutate(sd_lower = mean_diel_man_adj - 0.5*(sd(mean_diel_man_adj)),
         sd_upper = mean_diel_man_adj + 0.5*(sd(mean_diel_man_adj)))



```






```{r diel light regime}

library(suncalc)


all_ves_gmt8 <- all_sites_hp |>
  filter(Dep == "DAMPIER_202009_DNE" | 
           Dep == "DAMPIER_202009_DSW" | Dep == "GEOGRAPHE_202201_GEO" | Dep == "JURIEN_202201_JNE"
         | Dep == "JURIEN_202201_JSE"| Dep == "NINGALOO_201909_NGN"| Dep == "NINGALOO_201909_NGS" 
         | Dep == "SWC_202201_SWS"| Dep == "TWOROCKS_202105_TRE"| Dep == "TWOROCKS_202105_TRW") |>
  mutate(Hr_local_tz = force_tz(Hr_local, tzone = "Etc/GMT-8"),
         Begin_Date_UTC = as_date(with_tz(Hr_local_tz, tzone = "UTC")))|>
  
  rowwise()|>
  # get elevation of sun based on GPS location & time
  mutate(sun_elev_rad = suncalc::getSunlightPosition(Hr_local_tz, 
                                                     Lat_DD, 
                                                     Lon_DD, 
                                                     keep = "altitude")$altitude,
         sun_elev_deg = (sun_elev_rad*180)/(pi),
         twilight_times = getSunlightTimes(date = Begin_Date_UTC, 
                                           Lat_DD, 
                                           Lon_DD, 
                                           keep = c("nauticalDawn","sunset"),
                                           tz = "UTC")) |>
  mutate(nautDawn_UTC = twilight_times$nauticalDawn,
         nautDawn_loc = with_tz(nautDawn_UTC, tzone = "Etc/GMT-8"),
         sunset_UTC = twilight_times$sunset,
         sunset_loc = with_tz(sunset_UTC, tzone = "Etc/GMT-8")) |>
  mutate(
    light_reg = case_when(
      # if sun elev is positive, daytime
      sun_elev_deg > 0 ~ "day",
      # if sun elevation is less than -12, nighttime
      sun_elev_deg < -12 ~ "night",
      # if -12 <= elev <= 0) and before noon, 'dawn'
      sun_elev_deg <= 0 & sun_elev_deg >= -12 & Begin_Hour_loc < 12 ~"dawn",
      # if it's twilight (-12 <= elev <= 0) and after noon, 'dusk'
      sun_elev_deg <= 0 & sun_elev_deg >= -12 & Begin_Hour_loc > 12 ~ "dusk"
    ))




# start by getting counts per light regime
all_ves_gmt10 <- all_sites_hp |>
  filter(Dep == "CGMP_201807_CG" | Dep == "CGMP_201904_CG" | Dep == "SIMP_201808_EP" | Dep == "SIMP_201808_WP" | 
      Dep == "SIMP_201906_EP" | Dep == "SIMP_201906_WP" |
      Dep == "MURAT_202002_MRE" | Dep == "MURAT_202002_MRW") |>
  mutate(Hr_local_tz = force_tz(Hr_local, tzone = "Etc/GMT-10"),
         Begin_Date_UTC = as_date(with_tz(Hr_local_tz, tzone = "UTC")))|>
  
  rowwise()|>
  # get elevation of sun based on GPS location & time
  mutate(sun_elev_rad = suncalc::getSunlightPosition(Hr_local_tz, 
                                                     Lat_DD, 
                                                     Lon_DD, 
                                                     keep = "altitude")$altitude,
         sun_elev_deg = (sun_elev_rad*180)/(pi),
         twilight_times = getSunlightTimes(date = Begin_Date_UTC, 
                                           Lat_DD, 
                                           Lon_DD, 
                                           keep = c("nauticalDawn","sunset"),
                                           tz = "UTC")) |>
  mutate(nautDawn_UTC = twilight_times$nauticalDawn,
         nautDawn_loc = with_tz(nautDawn_UTC, tzone = "Etc/GMT-10"),
         sunset_UTC = twilight_times$sunset,
         sunset_loc = with_tz(sunset_UTC, tzone = "Etc/GMT-10")) |>
  mutate(
    light_reg = case_when(
      # if sun elev is positive, daytime
      sun_elev_deg > 0 ~ "day",
      # if sun elevation is less than -12, nighttime
      sun_elev_deg < -12 ~ "night",
      # if -12 <= elev <= 0) and before noon, 'dawn'
      sun_elev_deg <= 0 & sun_elev_deg >= -12 & Begin_Hour_loc < 12 ~"dawn",
      # if it's twilight (-12 <= elev <= 0) and after noon, 'dusk'
      sun_elev_deg <= 0 & sun_elev_deg >= -12 & Begin_Hour_loc > 12 ~ "dusk"
    ))


all_ves_gmt11 <- all_sites_hp |>
  filter(Dep == "CGMP_201812_CG" | 
      Dep == "SIMP_201812_EP" | Dep == "SIMP_201812_WP") |>
  mutate(Hr_local_tz = force_tz(Hr_local, tzone = "Etc/GMT-11"),
         Begin_Date_UTC = as_date(with_tz(Hr_local_tz, tzone = "UTC")))|>
  
  rowwise()|>
  # get elevation of sun based on GPS location & time
  mutate(sun_elev_rad = suncalc::getSunlightPosition(Hr_local_tz, 
                                                     Lat_DD, 
                                                     Lon_DD, 
                                                     keep = "altitude")$altitude,
         sun_elev_deg = (sun_elev_rad*180)/(pi),
         twilight_times = getSunlightTimes(date = Begin_Date_UTC, 
                                           Lat_DD, 
                                           Lon_DD, 
                                           keep = c("nauticalDawn","sunset"),
                                           tz = "UTC")) |>
  mutate(nautDawn_UTC = twilight_times$nauticalDawn,
         nautDawn_loc = with_tz(nautDawn_UTC, tzone = "Etc/GMT-11"),
         sunset_UTC = twilight_times$sunset,
         sunset_loc = with_tz(sunset_UTC, tzone = "Etc/GMT-11")) |>
  mutate(
    light_reg = case_when(
      # if sun elev is positive, daytime
      sun_elev_deg > 0 ~ "day",
      # if sun elevation is less than -12, nighttime
      sun_elev_deg < -12 ~ "night",
      # if -12 <= elev <= 0) and before noon, 'dawn'
      sun_elev_deg <= 0 & sun_elev_deg >= -12 & Begin_Hour_loc < 12 ~"dawn",
      # if it's twilight (-12 <= elev <= 0) and after noon, 'dusk'
      sun_elev_deg <= 0 & sun_elev_deg >= -12 & Begin_Hour_loc > 12 ~ "dusk"
    ))


# merge separate dataframes back into single df with hourly counts
 all_ves_light <- bind_rows(all_ves_gmt8, all_ves_gmt10, all_ves_gmt11) |>
   # group by light regime per day
   group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc, light_reg)|>
  # get vessel counts per light regime per day: total, inside, inside_small, maneuver, maneuver_small
  summarise(Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small, 
         network = case_when(npz_id == "CGMP" | npz_id == "SIMP" ~ "Temperate East",
                             npz_id == "DMP" | npz_id == "NMP" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west"))) 







#   rowwise()|>
#   mutate(nautDawn_UTC = twilight_times$nauticalDawn,
#          nautDawn_loc = with_tz(nautDawn_UTC, tzone = tz_local))
# 
# ,
#          nautDusk_UTC = twilight_times$nauticalDusk,
#          nautDusk_loc = with_tz(nautDusk_UTC, tzone = tz_local)) |>
# 
#   mutate(
#          light_reg = case_when(
#            sun_elev_deg > 0 ~ "day",
#            sun_elev_deg < -12 ~ "night",
#            sun_elev_deg <= 0 & sun_elev_deg >= -12 & Hr_local_tz > nautDawn_loc ~ "dawn",
#            TRUE ~ "dusk"
#          ))
# 
# 
# 
#   
#   group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc, Begin_Hour_loc)|>
#   # get daily vessel counts per weekday: total, inside, inside_small, maneuver, maneuver_small
#   summarise(Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
#             Total_inside = sum(total_inside, na.rm = TRUE),
#             Total_inside_small = sum(total_inside_small, na.rm = TRUE),
#             Inside_maneuver = sum(man_inside, na.rm = TRUE),
#             Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE)) |>
#   mutate(Inside_transit = Total_inside - Inside_maneuver,
#          Inside_transit_small = Total_inside_small - Inside_maneuver_small, 
#          network = case_when(npz_id == "CGMP" | npz_id == "SIMP" ~ "Temperate East",
#                              npz_id == "DMP" | npz_id == "NMP" ~ "Northwest", TRUE ~ "South-west"
#          ),
#          network = factor(network, levels = c("Temperate East","Northwest","South-west"))) 
# 
# 
# # Calculate daily mean-adjusted counts per light regime
 light_mean_adj_tot <- all_ves_light |>
  # group to date level
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
  # get n_hours per day
  summarize(n_hrs = n(),
            # and total vessels per day
            day_sum = sum(Total_ves_dep, na.rm = TRUE)) |>
  # only keep days with all light conditions == 4 (dawn/day/dusk/night)
  # and days with vessels present
  filter(n_hrs == 4,
         day_sum >0) |>
  # join to get counts by light regime back
  left_join(all_ves_light) |>
  # re-group to daily level
  group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
  # calculate mean total presence per day with vessels
  mutate(mean_tot = mean(Total_ves_dep, na.rm = TRUE),
         # calculate mean-adjusted counts per light regime
         tot_light_adj = Total_ves_dep - mean_tot) 
 
 
 # summarize means & SD for plots
 light_means_tot <- light_mean_adj_tot |>
  # group to light level per deployment
  group_by(network, npz_id, Dep_ID, light_reg) |>
  # get mean of mean-adjusted ounts per hour
  summarise(mean_light_adj = mean(tot_light_adj, na.rm =TRUE)) |>
  # get lower & upper bounds for SD around mean of adjusted counts
  mutate(sd_lower = mean_light_adj - 0.5*(sd(mean_light_adj)),
         sd_upper = mean_light_adj + 0.5*(sd(mean_light_adj)))
#   
# 
# 
# # Calculate daily mean-adjusted counts per hour for inside vessels
# daily_means_ins <- all_ves_diel |>
#   # group to date level
#   group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
#   # get n_hours per day
#   summarize(n_hrs = n(),
#             # and total vessels per day
#             day_sum = sum(Total_inside, na.rm = TRUE)) |>
#   # only keep full days n_hrs == 24
#   # and days with vessels present
#   filter(n_hrs == 24,
#          day_sum > 0) |>
#   # join to get hourly counts back
#   left_join(all_ves_diel) |>
#   # re-group to daily level
#   group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
#   # calculate mean total presence per day with vessels
#   mutate(mean_ins = mean(Total_inside, na.rm = TRUE),
#          # calculate mean-adjusted counts per hour
#          ins_diel_adj = Total_inside - mean_ins) |>
#   # group to hour level per deployment
#   group_by(network, npz_id, Dep_ID, Begin_Hour_loc) |>
#   # get mean of mean-adjusted ounts per hour
#   summarise(mean_diel_adj = mean(ins_diel_adj, na.rm =TRUE)) |>
#   # get lower & upper bounds for SD around mean of adjusted counts
#   mutate(sd_lower = mean_diel_adj - 0.5*(sd(mean_diel_adj)),
#          sd_upper = mean_diel_adj + 0.5*(sd(mean_diel_adj)))
# 
# 
# 
# # Calculate diel mean-adusted counts for maneuvers
# 
# daily_means_ins_man <- all_ves_diel |>
#   # group to date level
#   group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
#   # get n_hours per day
#   summarize(n_hrs = n(),
#             # and total vessels per day
#             day_sum = sum(Inside_maneuver, na.rm = TRUE)) |>
#   # only keep full days n_hrs == 24
#   # and days with vessels present
#   filter(n_hrs == 24,
#          day_sum > 0) |>
#   # join to get hourly counts back
#   left_join(all_ves_diel) |>
#   # re-group to daily level
#   group_by(network, npz_id, Dep_ID, Dep, Begin_Date_loc) |>
#   # calculate mean total presence per day with vessels
#   mutate(mean_ins_man = mean(Inside_maneuver, na.rm = TRUE),
#          # calculate mean-adjusted counts per hour
#          ins_diel_man_adj = Inside_maneuver - mean_ins_man) |>
#   # group to hour level per deployment
#   group_by(network, npz_id, Dep_ID, Begin_Hour_loc) |>
#   # get mean of mean-adjusted ounts per hour
#   summarise(mean_diel_man_adj = mean(ins_diel_man_adj, na.rm =TRUE)) |>
#   # get lower & upper bounds for SD around mean of adjusted counts
#   mutate(sd_lower = mean_diel_man_adj - 0.5*(sd(mean_diel_man_adj)),
#          sd_upper = mean_diel_man_adj + 0.5*(sd(mean_diel_man_adj)))
# 
# 


```





```{r plotting diel}
# plot total vessels
ggplot(data = daily_means_tot,
       aes(x = Begin_Hour_loc, 
           y = mean_diel_adj)) +
  geom_line(aes(group = Dep_ID),
            color = "gray70")+
  geom_pointrange(aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id,
                      color = ifelse(sd_lower <= 0, 'firebrick','blue')),
                  size = 0.25,
                  show.legend = FALSE) +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  scale_color_manual(values = c("red","black"))+
  scale_x_continuous(breaks = seq(0,23,2))+
  labs(y = "Mean-adjusted average N vessels / hour",
       x = "Hour of Day (Local TZ)",
       title = "Total vessels")+
   facet_nested(rows = vars(network, npz_id, Dep_ID), 
               nest_line = element_line(),
               scales = "free_y") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )
ggsave(paste0("figs/", "Diel_mean_adj_dep_presonly_withline.png"), width=8, height=12, units="in", dpi=300)
```



### Plotting diel -- total & inside

```{r combined total and inside diel}
#### Combined total & inside to help visualize differences in patterns

ggplot(data = daily_means_tot,
       aes(x = Begin_Hour_loc, 
           y = mean_diel_adj)) +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  
  
  # linerange for inside error bars
  geom_linerange(data = daily_means_ins,
                  aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id),
                      color = "black",
                  show.legend = FALSE) +
  # bar for inside vessels
  geom_col(data = daily_means_ins,
           aes(x = Begin_Hour_loc, 
               y = mean_diel_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               fill = ifelse(sd_lower >= 0, 'over',
                             ifelse(sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE
  ) +
  
  #translucent bar for total vessels
  geom_col(data = daily_means_tot,
           aes(x = Begin_Hour_loc,
               y = mean_diel_adj),
           show.legend = FALSE,
           alpha = 0.15,
           fill = "grey50")+
  
  # error bars for total vessels
  geom_linerange(aes(ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id),
                      color = "grey50",
                  # size = 0.1,
                  show.legend = FALSE) +

    scale_fill_manual(values = c("over" = "deepskyblue", 
                               "under" = "orange",
                               "center" = "grey75"))+
  scale_x_continuous(breaks = seq(0,23,2))+
  labs(y = "Mean-adjusted average N vessels / hour",
       x = "Hour of Day (Local TZ)",
       title = "")+
   facet_nested(rows = vars(network, npz_id, Dep_ID), 
               nest_line = element_line(),
               scales = "fixed") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )
```


```{r save combined diel plot}
ggsave(paste0("figs/", "Diel_mean_adj_combined_allbars.png"), width=8, height=12, units="in", dpi=300)

```


### Plotting diel -- inside & maneuver


```{r combined inside and maneuver diel}
#### Combined total & inside to help visualize differences in patterns

ggplot() +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  
  # pointrange for inside vessels
  # geom_pointrange(data = daily_means_ins,
  #      aes(x = Begin_Hour_loc, 
  #          y = mean_diel_adj, 
  #          ymin = sd_lower,
  #                     ymax = sd_upper,
  #                     group = npz_id),
  #                     color = "grey50",
  #                 size = 0.1,
  #                 show.legend = FALSE) +
  # 
  # linerange for maneuver error bars
  geom_linerange(data = daily_means_ins_man,
                  aes(x = Begin_Hour_loc,
                      ymin = sd_lower,
                      ymax = sd_upper,
                      group = npz_id),
                      color = "black",
                  show.legend = FALSE) +
  
  # bar for maneuvering vessels
    geom_col(data = daily_means_ins_man,
           aes(x = Begin_Hour_loc, 
               y = mean_diel_man_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               fill = ifelse(sd_lower >= 0, 'over',
                             ifelse(sd_upper <=0, 'under', 'center'))
           ),
           show.legend = FALSE
  ) +
  
  
    scale_fill_manual(values = c("over" = "deepskyblue", 
                               "under" = "orange",
                               "center" = "grey75"))+
  scale_x_continuous(breaks = seq(0,23,2))+
  scale_y_continuous(limits = c(-0.5,1.0))+
  labs(y = "Mean-adjusted average N vessels / hour",
       x = "Hour of Day (Local TZ)",
       title = "")+
   facet_nested(rows = vars(network, npz_id, Dep_ID), 
               nest_line = element_line(),
               scales = "fixed") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )
```


```{r save combined diel maneuver plot}
ggsave(paste0("figs/", "Diel_mean_adj_bars_maneuvers.png"), width=8, height=12, units="in", dpi=300)

```



### Crazy idea but it just might work?

```{r try weird idea for diel}

# Use transparency for total/inside/maneuvers

ggplot() +
  geom_hline(yintercept = 0, 
             linetype = 3, # dotted line
             colour = "black") +
  # bottom layer: total vessels (most transparent)
  geom_col(data = daily_means_tot,
           aes(x = Begin_Hour_loc, 
               y = mean_diel_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               # fill = ifelse(sd_lower >= 0, 'over',
               #               ifelse(sd_upper <=0, 'under', 'center'))
           ),
           fill = "white",
           color = "grey35",
           alpha = 0.2,
           show.legend = FALSE) +
  
  # middle layer: inside vessels (less transparent)
  geom_col(data = daily_means_ins,
           aes(x = Begin_Hour_loc, 
               y = mean_diel_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               # fill = ifelse(sd_lower >= 0, 'over',
               #               ifelse(sd_upper <=0, 'under', 'center')),
               color = ifelse(sd_lower >= 0, 'over',
                             ifelse(sd_upper <=0, 'under', 'center'))
           ),
           # alpha = 0.6,
           fill = "white",
           show.legend = FALSE) +
  
  # top layer: maneuvering vessels (least transparent)
    geom_col(data = daily_means_ins_man,
           aes(x = Begin_Hour_loc, 
               y = mean_diel_man_adj,
               # conditional fill based on lower SD value
               # "if mean +/- SD is above 0, 'over'
               fill = ifelse(sd_lower >= 0, 'over',
                             ifelse(sd_upper <=0, 'under', 'center')),
               color = ifelse(sd_lower >= 0, 'over',
                             ifelse(sd_upper <=0, 'under', 'center'))
           ),
           alpha = 0.6,
           show.legend = FALSE) +
  scale_fill_manual(values = c("over" = "deepskyblue", 
                               "under" = "orange",
                               "center" = "grey75"))+
    scale_color_manual(values = c("over" = "deepskyblue", 
                               "under" = "orange",
                               "center" = "grey75"))+
  scale_x_continuous(breaks = seq(0,23,2))+
  labs(y = "Mean-adjusted average N vessels / hour",
       x = "Hour of Day (Local TZ)",
       title = "")+
   facet_nested(rows = vars(network, npz_id, Dep_ID), 
               nest_line = element_line(),
               scales = "fixed") +
  theme(
    axis.text.x = element_text(face = "bold"),
    strip.background = element_blank(),
    strip.text.y = element_text(face = "bold")
    )

ggsave(paste0("figs/", "Diel_mean_adj_overlapping.png"), width=8, height=12, units="in", dpi=300)







```

```{r pooling SIMP sites}
### Compare CGMP deployments
cgmp_wkdy <- all_ves_wkdy |>
  filter(Site_ID == "CG") |>
  group_by(Dep, Weekday) |>
  summarise(Total_ves_dep = sum(Total_ves_dep)) |>
  pivot_wider(names_from = Dep, values_from = Total_ves_dep)

### Compare SIMP deployments
simp_wkdy <- all_ves_wkdy |>
  filter(npz_id == "SIMP")|>
  group_by(Dep, Weekday) |>
  summarise(Total_ves_dep = sum(Total_ves_dep)) |>
  pivot_wider(names_from = Dep, values_from = Total_ves_dep)

# Chi squared tests
# EP vs. WP in same deployment --> can we pool them?

chisq.test(as.data.frame(simp_wkdy[,2:3], row.names = FALSE)) # NS
chisq.test(as.data.frame(simp_wkdy[,4:5], row.names = FALSE)) # NS
chisq.test(as.data.frame(simp_wkdy[,6:7], row.names = FALSE)) # sig (but NS for same dates)

# test if WP subset to same dates is different
simp_epwp_dates <- all_ves_wkdy |>
  filter(npz_id == "SIMP", 
         Begin_Date_loc > "2019-06-10" & Begin_Date_loc < "2019-06-30") |>
  group_by(Dep, Weekday) |>
  summarise(Total_ves_dep = sum(Total_ves_dep)) |>
  pivot_wider(names_from = Dep, values_from = Total_ves_dep)


```


## Daily proportional hours present

Summarize by weekday

```{r prop across weekdays}

# from full hp dataset
# group down to date level to get daily vessel counts for each category (total, inside, inside_small, transit, maneuver)
# remove any days without vessels present
# group by deployment and weekday
# get proportion of vessel counts for each category occurring on each weekday
# 

all_ves_wkdy <- all_sites_hp |>
  group_by(network, npz_id, Site_ID, Dep, Weekday)|>
  # get daily vessel countsper weekday: total, inside, inside_small, maneuver, maneuver_small
  summarise(Total_ves_dep = sum(Total_Vessels, na.rm = TRUE),
            Total_inside = sum(total_inside, na.rm = TRUE),
            Total_inside_small = sum(total_inside_small, na.rm = TRUE),
            Inside_maneuver = sum(man_inside, na.rm = TRUE),
            Inside_maneuver_small = sum(man_inside_small, na.rm = TRUE)) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small, 
         Weekday = factor(Weekday, levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")),
         network = case_when(Site_ID == "CG" | Site_ID == "EP" | Site_ID == "WP" ~ "Temperate East",
                             Site_ID == "DNE" | Site_ID == "DSW" | Site_ID == "NGN"| Site_ID == "NGS" ~ "Northwest", TRUE ~ "South-west"
         ),
         network = factor(network, levels = c("Temperate East","Northwest","South-west"))) |>
  filter(Total_ves_dep > 0) 

levels(all_ves_wkdy$Weekday) <- c("M","T","W","R","F","Sa","Su")


# function to calculate Agresti-Coull interval
# from https://towardsdatascience.com/five-confidence-intervals-for-proportions-that-you-should-know-about-7ff5484c024f
AgrestiInterval <- function(x, n, conf.level = 0.95){
 p <- (x+2)/(n+4)
 sd <- sqrt(p*((1-p)/(n+4)))
 z <- qnorm(c( (1 - conf.level)/2, 1- (1-conf.level)/2)) #returns the value of thresholds at which conf.level has to be cut at. for 95% CI, this is -1.96 and +1.96
 ci <- p + z*sd
 return(ci)
 }

wkdy_prop_table <- all_ves_wkdy |>
  group_by(network, npz_id, Site_ID, Dep) |>
  mutate(Inside_transit = Total_inside - Inside_maneuver,
         Inside_transit_small = Total_inside_small - Inside_maneuver_small,
         tot_prop = Total_ves_dep/sum(Total_ves_dep),
         ins_prop = Total_inside/sum(Total_inside),
         small_prop = Total_inside_small/sum(Total_inside_small),
         ins_trans_prop = Inside_transit/sum(Inside_transit),
         small_trans_prop = Inside_transit_small/sum(Inside_transit_small),
         ins_man_prop = Inside_maneuver/sum(Inside_maneuver),
         small_man_prop = Inside_maneuver_small/sum(Inside_maneuver_small))

wkdy_prop_long <- wkdy_prop_table |>
  pivot_longer(cols = -c(network, npz_id, Site_ID, Dep, Weekday), 
               values_to = "Weekday_prop", names_to = "Ves_behav") |>
  filter(grepl("prop", Ves_behav)) |>
  # relevel categorical values for plotting
  mutate(Ves_behav = fct(Ves_behav),
         Ves_behav = fct_relevel(Ves_behav, c("tot_prop","small_prop", "ins_prop", "small_trans_prop","small_man_prop", "ins_trans_prop","ins_man_prop")),
         # network = fct(network),
         network = fct_relevel(network, c("Temperate East","Northwest")), 
         npz_id = fct(npz_id),
         npz_id = fct_relevel(npz_id, c("CGMP","SIMP","DMP","NMP")))



# TO DO:
# - calculate A-C confidence intervals for each proportion
# - add CI's to plot
```




## Proportional hours present

For days with presence AND 24 total hours (i.e., full days only)
- Calculate proportion of hours present (n/24)
- Summarize by weekday (median, 25th - 75th percentiles)


```{r weekday prophrs}
#### Proportional by hours present rather than counts ####

# start with full hp dataset
all_perc_weekday <- all_sites_hp |>
  # group by date to get % presence per day 
  group_by(network, npz_id, Site_ID, Dep, Date_noyr, Begin_Date_loc, Weekday, ves_yn) |>
  # get total number of hours for Y and N groups per each hour per deployment
  summarize(n_hours = n())|>
  # only keep full days
  filter(sum(n_hours) == 24) |>
  # calculate proportion hours present per day
  mutate(freq = n_hours/sum(n_hours)) |>
  # ungroup to fill in any missing values for columns
  ungroup() |>
  complete(Dep, Weekday, ves_yn,
           fill = list(ves_yn = "Y", freq = 0)) |>
  # regroup
  group_by(network, npz_id, Site_ID, Dep, Begin_Date_loc, Weekday, ves_yn) |>
  # reshape for easier plotting
  pivot_longer(cols = c("freq"),
               values_to = "Perc_per_hour") |>
  mutate(Weekday = factor(Weekday, levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")),
          network = case_when(Site_ID == "CG" | Site_ID == "EP" | Site_ID == "WP" ~ "Temperate East",
                              Site_ID == "DNE" | Site_ID == "DSW" | Site_ID == "NGN"| Site_ID == "NGS" ~ "Northwest",
                              TRUE ~ "South-west"
          ),
          network = factor(network, levels = c("Temperate East","Northwest","South-west")))
levels(all_perc_weekday$Weekday) <- c("M","T","W","R","F","Sa","Su")


# summarize proportion hours present

# by deployment
perc_wkdy_summ_dep <- all_perc_weekday |>
  # only interested in proportion present
  filter(ves_yn == "Y") |>
  ungroup()|>
  # group down to weekday level to summarize
  group_by(network, npz_id, Site_ID, Dep, Weekday)|>
  summarise(median_prop = median(Perc_per_hour),
            qt25 = quantile(Perc_per_hour, probs = 0.25),
            qt75 = quantile(Perc_per_hour, probs = 0.75),
            min_perc = min(Perc_per_hour, na.rm = TRUE),
            max_perc = max(Perc_per_hour, na.rm = TRUE))

# by npz
perc_wkdy_summ_npz <- all_perc_weekday |>
  filter(ves_yn == "Y") |>
  ungroup()|>
  group_by(network, npz_id, Weekday)|>
  summarise(median_prop = median(Perc_per_hour),
            qt25 = quantile(Perc_per_hour, probs = 0.25),
            qt75 = quantile(Perc_per_hour, probs = 0.75),
            min_perc = min(Perc_per_hour, na.rm = TRUE),
            max_perc = max(Perc_per_hour, na.rm = TRUE))

```


Daily proportion of hours present, summarized by weekday
"For days with vessels present, what proportion of the day had vessels?
When those are summarized by Weekday, what's the median value for each weekday at each NPZ?"

```{r weekday proportion hours}

## Try individual npz's for a single network

## Temperate East
ggplot(data = all_perc_weekday |>
         filter(ves_yn == "Y",
                !is.na(npz_id),
                network == "Temperate East"),
       aes(x = Weekday,
           y = Perc_per_hour,
           fill = npz_id,
           color = npz_id))+
  geom_boxplot(
    position = position_dodge2(preserve = "single"),
    alpha = 0.75,
    width = 0.5)+
  scale_fill_viridis_d(end = 0.75,
                       direction = -1
  )+
  scale_color_viridis_d(end = 0.75,
                        direction = -1,
                        guide = "none")+
  facet_grid(rows = vars(Dep),
             drop = TRUE) +
  labs(x = "Weekday",
       y = "Proportion hours per weekday",
       fill = "Deployment") +
  theme(
    strip.text.y = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold")
  )
# 
ggsave(paste0("figs/", "Weekday_prop_hrs_npz_tempeast_dep.png"), width=6, height=10,
       units="in", dpi=300)




## Northwest
ggplot(data = all_perc_weekday |>
         filter(ves_yn == "Y",
                !is.na(npz_id),
                network == "Northwest"),
       aes(x = Weekday,
           y = Perc_per_hour,
           fill = npz_id,
           color = npz_id))+
  geom_boxplot(
    position = position_dodge2(preserve = "single"),
    alpha = 0.75,
    width = 0.5)+
  scale_fill_viridis_d(end = 0.75,
                       direction = -1
  )+
  scale_color_viridis_d(end = 0.75,
                        direction = -1,
                        guide = "none")+
  facet_grid(rows = vars(npz_id),
             drop = TRUE) +
  labs(x = "Weekday",
       y = "Proportion hours per weekday",
       fill = "NPZ") +
  theme(
    strip.text.y = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold")
  )
# 
ggsave(paste0("figs/", "Weekday_prop_hrs_npz_northwest.png"), width=6, height=10,
       units="in", dpi=300)

## South-west
ggplot(data = all_perc_weekday |>
         filter(ves_yn == "Y",
                !is.na(npz_id),
                network == "South-west"),
       aes(x = Weekday,
           y = Perc_per_hour,
           fill = npz_id,
           color = npz_id))+
  geom_boxplot(
    position = position_dodge2(preserve = "single"),
    alpha = 0.75,
    width = 0.5)+
  scale_fill_viridis_d(end = 0.75,
                       direction = -1
  )+
  scale_color_viridis_d(end = 0.75,
                        direction = -1,
                        guide = "none")+
  facet_grid(rows = vars(npz_id),
             drop = TRUE) +
  labs(x = "Weekday",
       y = "Proportion hours per weekday",
       fill = "NPZ") +
  theme(
    strip.text.y = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold")
  )
# 
ggsave(paste0("figs/", "Weekday_prop_hrs_npz_southwest.png"), width=6, height=10,
       units="in", dpi=300)


# no facets, plotting at network level

ggplot(data = all_perc_weekday |>
         filter(ves_yn == "Y",
                Perc_per_hour > 0, 
                !is.na(npz_id)),
       aes(x = Weekday,
           y = Perc_per_hour,
           fill = network,
           color = network))+
  geom_boxplot(
    position = position_dodge2(preserve = "single"),
    alpha = 0.75,
    width = 0.5)+
  scale_fill_viridis_d(end = 0.75,
                       direction = -1
  )+
  scale_color_viridis_d(end = 0.75,
                        direction = -1,
                        guide = "none")+
  # facet_grid(rows = vars(npz_id),
  #            drop = TRUE) +
  labs(x = "Weekday",
       y = "Hours present / hours per day",
       fill = "Network") +
  theme(
    strip.text.y = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold"),
    axis.text.x = element_text(face = "bold")
  )
ggsave(paste0("figs/", "Weekday_prop_hrs_nofacets.png"), width=6, height=10,
       units="in", dpi=300)





```



## Plotting weekday proportions

```{r weekday plots}


wkday_prop_total <- wkdy_prop_long |>
  filter(Ves_behav == "tot_prop")

ggplot(data = wkday_prop_total,
       aes(x = Weekday, 
           y = Weekday_prop)) +
  geom_col(aes(fill = network),
           position = position_dodge()) +
  scale_fill_viridis_d(end = 0.75, direction = -1)+
  labs(y = "Proportion", 
       x = "Weekday", 
       fill = "Network")+  
  facet_grid(rows = vars(npz_id)) +
   theme(
    axis.text.x = element_text(face = "bold"),
    strip.text.y = element_text(face = "bold")
    )



ggsave(paste0("figs/", "Weekday_props_npz.png"), width=8, height=10,
       units="in", dpi=300)




wkday_prop_ins <- wkdy_prop_long |>
  filter(Ves_behav == "ins_prop" | Ves_behav == "ins_trans_prop" | Ves_behav == "ins_man_prop")

ggplot(data = wkday_prop_ins |> filter (npz_id != "MMP" & npz_id != "SWCMP"),
       aes(x = Weekday, 
           y = Weekday_prop)) +
  geom_col(aes(fill = Ves_behav),
           position = position_dodge()) +
  scale_fill_viridis_d(end = 0.75, direction = -1)+
  labs(y = "Proportion", 
       x = "Weekday", 
       fill = "Network")+  
  facet_grid(rows = vars(npz_id),
             cols = vars(Ves_behav)) +
   theme(
    axis.text.x = element_text(face = "bold"),
    strip.text.y = element_text(face = "bold")
    )



ggsave(paste0("figs/", "Weekday_props_npz_inside.png"), width=8, height=10, units="in", dpi=300)






```



### Export CSV summary tables

```{r export tables}

# Total vessel presence
write_csv(all_ves_by_site, 
          file = "output/All_ves_by_dep.csv")
write_csv(all_ves_by_npz, 
          file = "output/All_ves_by_npz.csv")
write_csv(all_ves_wkdy, 
          file = "output/All_ves_by_weekday.csv")
write_csv(cgmp_wkdy,
          file = "output/CGMP_by_weekday.csv")

write_csv(all_perc_weekday, 
          file = "output/All_ves_prophr_weekday.csv")
write_csv(perc_wkdy_summ_npz, 
          file = "output/All_ves_prophr_weekday_npz.csv")
write_csv(perc_wkdy_summ_dep, 
          file = "output/All_ves_prophr_weekday_dep.csv")
write_csv(all_ves_diel, 
          file = "output/All_ves_diel_counts.csv")
write_csv(diel_mean_adj, 
          file = "output/All_ves_diel_mean_adj.csv")

```
